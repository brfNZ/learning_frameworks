<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art of War - 52 Week Tracker</title>
    <style>
   /* ========================================
   ROOT VARIABLES (DEFAULT = DARK THEME)
   ======================================== */
:root {
    /* Core Colors */
    --color-bg-primary: #0f172a;
    --color-bg-secondary: #1e293b;
    --color-bg-tertiary: #334155;
    --color-bg-card: #475569;
    --color-bg-input: #334155;
    --color-bg-hover: #2d3748;
    --color-bg-light: #e2e8f0;

    --color-text-primary: #e2e8f0;
    --color-text-secondary: #cbd5e1;
    --color-text-muted: #94a3b8;
    --color-text-dim: #64748b;

    --color-accent: #fbbf24;         /* Orange in dark */
    --color-accent-dark: #b45309;    /* Deep amber in light */
    --color-btn-primary: #b45309;
    --color-btn-primary-hover: #92400e;
    --color-btn-success: #059669;
    --color-btn-success-hover: #047857;
    --color-btn-purple: #7c3aed;
    --color-btn-purple-hover: #6d28d9;

    --border-color: #64748b;
    --border-color-hover: #fbbf24;
    --shadow: 0 20px 25px rgba(0, 0, 0, 0.3);
    --scrollbar-track: #1e293b;
    --scrollbar-thumb: #64748b;
    --scrollbar-thumb-hover: #94a3b8;
}

/* ========================================
   LIGHT THEME OVERRIDE
   ======================================== */
[data-theme="light"] {
    --color-bg-primary: #f8fafc;
    --color-bg-secondary: #e2e8f0;
    --color-bg-tertiary: #cbd5e1;
    --color-bg-card: #e2e8f0;
    --color-bg-input: #f1f5f9;
    --color-bg-hover: #cbd5e1;
    --color-bg-light: #f8fafc;

    --color-text-primary: #1e293b;
    --color-text-secondary: #475569;
    --color-text-muted: #64748b;
    --color-text-dim: #94a3b8;

    --color-accent: #d97706;
    --color-accent-dark: #b45309;

    --border-color: #cbd5e1;
    --border-color-hover: #fbbf24;
    --shadow: 0 20px 25px rgba(0, 0, 0, 0.1);
    --scrollbar-track: #e2e8f0;
    --scrollbar-thumb: #9ca3af;
    --scrollbar-thumb-hover: #6b7280;
}

/* ========================================
   GLOBAL STYLES
   ======================================== */
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    background: linear-gradient(to bottom right,
        var(--color-bg-secondary),
        var(--color-bg-tertiary),
        var(--color-bg-primary)
    );
    min-height: 100vh;
    font-family: system-ui, -apple-system, sans-serif;
    padding: 20px;
    color: var(--color-text-primary);
}

.container { max-width: 900px; margin: 0 auto; }

.header { text-align: center; margin-bottom: 40px; }
.header h1 { font-size: 48px; margin-bottom: 10px; color: white; }
.header h2 { font-size: 28px; font-weight: bold; color: white; margin-bottom: 8px; }
.header p { color: var(--color-text-secondary); }

.main {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}
@media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }

.card {
    background: var(--color-bg-card);
    border-radius: 12px;
    padding: 30px;
    box-shadow: var(--shadow);
    border: 1px solid var(--border-color);
}

/* ---------- PASSAGE & VERSE ---------- */
.passage-display {
    text-align: center;
    padding: 20px;
    background: var(--color-bg-tertiary);
    border-radius: 8px;
    margin-bottom: 20px;
}
.week-number { font-size: 20px; margin-bottom: 10px; color: var(--color-text-muted); }
.passage-title { color: var(--color-accent); font-size: 36px; font-weight: bold; line-height: 1.3; }
.passage-chapter { color: var(--color-accent); font-size: 14px; margin-top: 10px; }
.context-indicator {
    color: var(--color-text-muted);
    font-size: 12px;
    margin-top: 8px;
    font-style: italic;
}

.verse-display {
    padding: 20px;
    background: var(--color-bg-secondary);
    border-radius: 8px;
    margin-top: 15px;
    cursor: pointer;
    transition: background 0.2s;
}
.verse-display:hover { background: var(--color-bg-hover); }

.verse-author {
    color: var(--color-text-muted);
    font-size: 11px;
    font-style: italic;
    margin-bottom: 12px;
}
.verse-text-wing { text-align: center; }
.verse-text {
    color: var(--color-text-primary);
    font-size: 16px;
    line-height: 1.7;
    white-space: pre-line;
    max-height: 400px;
    overflow-y: auto;
    text-align: left;
}
.verse-text-missing {
    color: var(--color-text-muted);
    font-style: italic;
}
/* Scrollbars */
.verse-text::-webkit-scrollbar { width: 8px; }
.verse-text::-webkit-scrollbar-track {
    background: var(--scrollbar-track);
    border-radius: 4px;
}
.verse-text::-webkit-scrollbar-thumb {
    background: var(--scrollbar-thumb);
    border-radius: 4px;
}
.verse-text::-webkit-scrollbar-thumb:hover {
    background: var(--scrollbar-thumb-hover);
}

.verse-footnote {
    font-size: 11px;
    font-style: italic;
    color: var(--color-text-dim);
    margin-top: 16px;
}

/* ---------- TITLE STYLES (CHAPTER & PART) ---------- */
.chapter-number,
.part-number {
    color: #cbd5e1;
    font-size: 16px;
    margin-top: 12px;
}

.chapter-title {
    color: var(--color-accent) !important;
    font-size: 28px;
    font-weight: bold;
    margin-top: 4px;
}

.part-title {
    color: var(--color-accent) !important;
    font-size: 24px;
    font-weight: bold;
    margin-top: 4px;
}

/* LIGHT MODE OVERRIDE */
[data-theme="light"] .chapter-title,
[data-theme="light"] .part-title {
    color: #d97706 !important;
    font-weight: 700;
}

/* ---------- BUTTONS ---------- */
.button-group {
    display: flex;
    gap: 12px;
    margin: 10px 0 20px;
}
button {
    font-weight: bold;
    padding: 12px 16px;
    border: none;
    border-radius: 8px;
    font-size: 14px;
    cursor: pointer;
    transition: background 0.2s;
    flex: 1;
}
.next-btn, .reset-btn {
    background: var(--color-btn-primary);
    color: white;
}
.next-btn:hover, .reset-btn:hover {
    background: var(--color-btn-primary-hover);
}
.save-btn {
    background: var(--color-btn-success);
    color: white;
}
.save-btn:hover { background: var(--color-btn-success-hover); }
.export-btn {
    background: var(--color-btn-purple);
    color: white;
}
.export-btn:hover { background: var(--color-btn-purple-hover); }
.theme-toggle-btn {
    background: var(--color-btn-purple);
    color: white;
    font-size: 16px;
    padding: 12px 8px;
    width: 50px;
}
.theme-toggle-btn:hover { background: var(--color-btn-purple-hover); }

/* ---------- FORM ELEMENTS ---------- */
textarea {
    width: 100%;
    height: 200px;
    padding: 12px;
    background: var(--color-bg-input);
    color: var(--color-text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-family: system-ui;
    font-size: 14px;
    resize: vertical;
}
textarea::placeholder { color: var(--color-text-muted); }

input[type="text"] {
    padding: 10px;
    background: var(--color-bg-secondary);
    color: var(--color-text-primary);
    border: 1px solid var(--border-color);
    border-radius: 8px;
    font-size: 14px;
}

/* ---------- JOURNAL ---------- */
.journal-section h3 {
    color: white;
    margin-bottom: 12px;
    font-size: 16px;
}
.manual-week {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 12px;
    margin-bottom: 20px;
    padding: 12px;
    background: var(--color-bg-tertiary);
    border-radius: 8px;
}
.entries-list { max-height: 400px; overflow-y: auto; margin-bottom: 12px; }

.entry-item {
    background: var(--color-bg-tertiary);
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    cursor: pointer;
    border: 1px solid var(--border-color);
    transition: background 0.2s, border-color 0.2s;
}
.entry-item:hover {
    background: #3f4a5c;
    border-color: var(--border-color-hover);
}
[data-theme="light"] .entry-item:hover {
    background: #fed7aa;
    border-color: var(--border-color-hover);
}

.entry-chapter-title { color: var(--color-text-secondary); font-size: 12px; margin: 2px 0 4px; }
.entry-chapter-ref { color: var(--color-accent); font-size: 13px; font-weight: bold; }
.entry-date { color: var(--color-text-muted); font-size: 11px; margin-bottom: 4px; }
.entry-title { color: var(--color-accent); font-size: 13px; font-weight: bold; }
.entry-preview { color: var(--color-accent); font-size: 11px; }
.entry-separator { color: var(--color-text-muted); font-weight: normal; }

.footer {
    text-align: center;
    color: var(--color-text-dim);
    font-size: 12px;
    margin-top: 30px;
}

/* ========================================
   LIGHT MODE SPECIFIC TWEAKS
   ======================================== */
[data-theme="light"] .header h1,
[data-theme="light"] .header h2 { color: var(--color-text-primary); }
[data-theme="light"] .header p { color: var(--color-text-secondary); }
[data-theme="light"] .week-number,
[data-theme="light"] .context-indicator,
[data-theme="light"] .passage-chapter { color: var(--color-bg-primary); }
[data-theme="light"] .journal-section h3 { color: var(--color-text-primary); }
[data-theme="light"] .verse-author,
[data-theme="light"] .entry-date,
[data-theme="light"] .footer { color: var(--color-text-dim); }

/* LIGHT MODE: High contrast for chapter/part labels */
[data-theme="light"] .chapter-number,
[data-theme="light"] .part-number {
    color: #1e293b;
    font-weight: 600;
}
[data-theme="light"] .part-number {
    color: #475569;
}

/* LIGHT MODE: Titles (Chapter & Part) */
[data-theme="light"] .chapter-title,
[data-theme="light"] .part-title {
    color: var(--color-accent-dark);
    font-weight: 700;
}

        .part-title { color: #fbbf24 !important; }
        
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öî</h1>
            <h2>Art of War</h2>
            <p>52-Week Strategy Study</p>
        </div>

        <div class="main">
            <div class="card">
                <div id="combinedDisplay"></div>
                    <div class="button-group">
                        <button class="reset-btn" id="prevBtn">Previous</button>
                        <button class="next-btn" id="nextBtn">Next</button>
                    </div>
            </div>
            
            <div class="card journal-section">
                <h3>Journal Entry</h3>
                <textarea id="journalText" placeholder="Write your reflections on this week's passage..."></textarea>
                
            <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 12px; margin: 12px 0; align-items: stretch;">                <button class="save-btn" id="saveBtn">Save Entry</button>
                <button class="export-btn" id="exportBtn">Export to CSV</button>
                <button class="theme-toggle-btn" id="themeToggleBtn">‚òÄÔ∏è</button>
            </div>

                <div class="manual-week">
                    <input type="text" id="manualChapter" placeholder="Jump to Ch. (e.g.1 or 2-3)">
                    <button id="manualChapterBtn">Go to Chapter</button>  
                </div>
                
                <h3>Past Entries</h3>
                <div class="entries-list" id="entriesList"></div>
            </div>
        </div>

        <p class="footer">Study The Art of War through multiple translations. Click the verse text to switch translations.</p>
    </div>

    <!-- STEP 1: Load the translation verse files -->
    <script src="war-verses/verses-giles.js"></script>
    <script src="war-verses/verses-wing.js"></script>
    
    <!-- STEP 2: Load the main verses.js file (contains titles and helper functions) -->
    <script src="war-verses/verses.js"></script>
    
    <script>
        // LEARNING NOTE: The app object stores the current state of the application
        var app = {
            currentPosition: 1,              // Which week (1-52) we're on
            currentEditId: null,         // If editing an existing journal entry, store its index
            currentTranslation: "Giles", // Which translation to display (Giles or Wing)
            entries: []                  // Array of saved journal entries
        };

        // THEME TOGGLE: Dark/Light mode
        var currentTheme = localStorage.getItem('artOfWarTheme') || 'dark';
        
        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('artOfWarTheme', theme);
            document.documentElement.setAttribute('data-theme', theme);
            updateThemeButton();
        }
        
        function updateThemeButton() {
            var btn = document.getElementById('themeToggleBtn');
            btn.textContent = currentTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        
        function toggleTheme() {
            setTheme(currentTheme === 'dark' ? 'light' : 'dark');
        }
        
        // LEARNING NOTE: This function switches between available translations
        // It cycles through: Giles ‚Üí Wing ‚Üí back to Giles
        function cycleTranslation() {
            var translations = Object.keys(verseTexts);
            var currentIndex = translations.indexOf(app.currentTranslation);
            var nextIndex = (currentIndex + 1) % translations.length;
            
            // Get current chapter info before switching
            var currentInfo = getPositionInfo(app.currentPosition, app.currentTranslation);
            var currentChapter = currentInfo.chapter;
            
            // Switch translation
            app.currentTranslation = translations[nextIndex];
            
            // Adjust position to match the same chapter in the new translation
            if (app.currentTranslation === "Wing") {
                // Switching to Wing: go to Part 1 of the same chapter
                app.currentPosition = (currentChapter - 1) * 4 + 1;
            } else {
                // Switching to Giles: go to the same chapter number
                app.currentPosition = currentChapter;
            }
            
            render();
        }

        // LEARNING NOTE: This is the main function that updates what you see on screen
        function render() {
            // STEP 1: Get information about the current chapter/part
            var weekInfo = getPositionInfo(app.currentPosition, app.currentTranslation);
            var weekTitle = getPositionTitle(app.currentPosition, app.currentTranslation);
            
            // STEP 2: Build the verse key to look up the text
            var verseKey = weekInfo.chapter.toString();
            if (weekInfo.section !== null) {
                verseKey += '-' + weekInfo.section;
            }
            
            // STEP 3: Get chapter title for this translation
            var chapterTitle;
            if (app.currentTranslation === "Wing") {
                chapterTitle = chapterTitlesWing[weekInfo.chapter - 1];
            } else {
                chapterTitle = chapterTitlesGiles[weekInfo.chapter - 1];
            }
            
            // STEP 4: Build the combined display
            var display = '<div class="verse-display" onclick="cycleTranslation()">';
            
            // Translation label
            display += '<div class="verse-author">Translation: ' + app.currentTranslation + '</div>';
            
            // Chapter number
            display += '<div class="chapter-number">Chapter ' + weekInfo.chapter + '</div>';            
            // Chapter title
            display += '<div class="chapter-title">' + chapterTitle + '</div>';
            
            // For Wing: show Part number and Part title
            if (weekInfo.section !== null) {
                display += '<div class="part-number">Part ' + weekInfo.section + '</div>';
                var partTitle = getPositionTitle(app.currentPosition, app.currentTranslation);
                display += '<div class="part-title">' + partTitle + '</div>';
            }
            
            // Separator line
            display += '<div style="border-top: 1px solid #64748b; margin: 20px 0;"></div>';
            
            // STEP 5: Add the verse text if available
            if (typeof verseTexts !== 'undefined' && 
                verseTexts[app.currentTranslation] && 
                verseTexts[app.currentTranslation][verseKey]) {
                
                var verseText = verseTexts[app.currentTranslation][verseKey];
                
                // Style footnotes differently (text after underscores)
                if (verseText.includes('___')) {
                    var parts = verseText.split('___');
                    verseText = parts[0] + '<div class="verse-footnote">___' + parts.slice(1).join('___') + '</div>';
                }
                
                // Add Wing-specific centering class
                var textClass = app.currentTranslation === 'Wing' ? 'verse-text verse-text-wing' : 'verse-text';
                display += '<div class="' + textClass + '">' + verseText + '</div>';
            } else {
                display += '<div class="verse-text verse-text-missing">Verse text not yet added</div>';
            }
            
            display += '</div>';
            
            // Update the combined display
            document.getElementById('combinedDisplay').innerHTML = display;
        
            // STEP 6: Display the list of saved journal entries
            var listHTML = '';
            for (var i = app.entries.length - 1; i >= 0; i--) {
                var e = app.entries[i];
                
                // Build chapter reference
            var chapterRef = 'Ch ' + e.chapter;
            if (e.section) {
                chapterRef += '.' + e.section;
            }
            chapterRef += ' (' + (e.translation === 'Wing' ? 'W' : 'G') + ')';
                            
           // Format date as day-month-year
            var dateParts = e.date.split('-');
            var formattedDate = dateParts[2] + '-' + dateParts[1] + '-' + dateParts[0];

            // Get chapter title for Wing entries
            var chapterTitleLine = '';
            if (e.translation === 'Wing' && e.section) {
                var chapterTitle = chapterTitlesWing[e.chapter - 1];
                chapterTitleLine = '<div class="entry-chapter-title">' + chapterTitle + '</div>';
            }

            listHTML += '<div class="entry-item" onclick="loadEntry(' + i + ')">' +
                '<div class="entry-date">' + formattedDate + '</div>' +
                '<div class="entry-header">' +
                    '<span class="entry-chapter-ref">' + chapterRef + '</span>' +
                    '<span class="entry-separator"> - </span>' +
                    '<span class="entry-title">' + e.title + '</span>' +
                '</div>' +
                chapterTitleLine +
                '<div class="entry-preview">' + e.text.substring(0, 60) + '...</div>' +
                '</div>';
            }
            document.getElementById('entriesList').innerHTML = listHTML;
                        
            // Save current position to localStorage
            localStorage.setItem('artOfWarPosition', JSON.stringify({
                week: app.currentPosition,
                translation: app.currentTranslation
            }));

            // Update URL without reloading page
            var weekInfo = getPositionInfo(app.currentWeek, app.currentTranslation);
            var chapterParam = weekInfo.chapter.toString();
            if (weekInfo.section !== null) {
                chapterParam += '-' + weekInfo.section;
            }
            var newUrl = window.location.pathname + '?ch=' + chapterParam + '&tr=' + app.currentTranslation;
            window.history.replaceState({}, '', newUrl);
                    }
                
        // LEARNING NOTE: Move to the next week
        function nextChapter() {
            if (app.currentPosition < 52) {
                app.currentPosition++;
                app.currentEditId = null;  // Clear any editing state
                document.getElementById('journalText').value = '';  // Clear the text box
                render();
            }
        }

        function previousChapter() {
            if (app.currentPosition > 1) {
                app.currentPosition--;
                app.currentEditId = null;
                document.getElementById('journalText').value = '';
                render();
            }
        }

        // LEARNING NOTE: Jump to a specific chapter number
        function manualChapter() {
            var input = document.getElementById('manualChapter').value.trim();
            
            // Parse input: "2" or "2-3"
            var parts = input.split('-');
            var chapter = parseInt(parts[0]);
            var section = parts[1] ? parseInt(parts[1]) : 1;
            
            // Validate chapter number (1-13)
            if (isNaN(chapter) || chapter < 1 || chapter > 13) {
                alert('Enter a chapter number between 1 and 13 (e.g., 5 or 5-2)');
                return;
            }
            
            // Validate section number if provided (1-4)
            if (parts[1] && (isNaN(section) || section < 1 || section > 4)) {
                alert('Part number must be between 1 and 4 (e.g., 2-3)');
                return;
            }

            // If section is specified and we're in Giles, switch to Wing
            if (section > 1 && app.currentTranslation === 'Giles') {
                app.currentTranslation = 'Wing';
            }
            
            // Convert chapter-section to week number
            // For Wing (or when section specified): week = (chapter-1)*4 + section
            // For Giles (when no section): week = chapter
            if (section > 1 || app.currentTranslation === 'Wing') {
                app.currentPosition = (chapter - 1) * 4 + section;
            } else {
                app.currentPosition = chapter;
            }
            
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            document.getElementById('manualChapter').value = '';
            render();
        }
                
        // LEARNING NOTE: Save a journal entry
        function saveEntry() {
            var weekInfo = getPositionInfo(app.currentPosition, app.currentTranslation);
            var weekTitle = getPositionTitle(app.currentPosition, app.currentTranslation);
            var text = document.getElementById('journalText').value;
            var now = new Date().toISOString().split('T')[0];  // Get today's date in YYYY-MM-DD format

            // Either update an existing entry or create a new one
            if (app.currentEditId !== null) {
                app.entries[app.currentEditId].text = text;
            } else {
              app.entries.push({ 
                chapter: weekInfo.chapter,
                section: weekInfo.section,  // Will be null for Giles
                translation: app.currentTranslation,
                title: weekTitle, 
                date: now, 
                text: text 
            });
            }
            
            // Save to browser's localStorage so entries persist between sessions
            localStorage.setItem('artOfWarEntries', JSON.stringify(app.entries));
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            alert('Entry saved!');
            render();
        }

        // LEARNING NOTE: Load an existing journal entry for editing
        function loadEntry(idx) {
            app.currentEditId = idx;
            document.getElementById('journalText').value = app.entries[idx].text;
        }

        // LEARNING NOTE: Export all entries to a CSV file
        function exportCSV() {
            var csv = 'Date,Translation,Chapter,Part,Title,Notes\n';
            for (var i = 0; i < app.entries.length; i++) {
                var e = app.entries[i];
                var notes = e.text.replace(/"/g, '""').replace(/\n/g, ' ');
                var part = e.section || '';  // Empty for Giles
                csv += e.date + ',' + e.translation + ',' + e.chapter + ',' + part + ',"' + e.title + '","' + notes + '"\n';
            }
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'art-of-war-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // LEARNING NOTE: Initialize the app when page loads
          function init() {
            // Load saved journal entries
            var saved = localStorage.getItem('artOfWarEntries');
            if (saved) app.entries = JSON.parse(saved);
            
            // Check URL parameters first (higher priority)
            var urlParams = new URLSearchParams(window.location.search);
            var urlChapter = urlParams.get('ch');
            var urlTranslation = urlParams.get('tr');
            
            if (urlChapter) {
                // URL has chapter parameter - use it
                // Parse "2-3" format or just "2"
                var parts = urlChapter.split('-');
                var chapter = parseInt(parts[0]);
                var section = parts[1] ? parseInt(parts[1]) : 1;
                
                // Convert chapter-section to week number
                if (urlTranslation === 'Wing' || section > 1) {
                    app.currentPosition = (chapter - 1) * 4 + section;
                } else {
                    app.currentPosition = chapter;
                }
                
                if (urlTranslation) {
                    app.currentTranslation = urlTranslation;
                }
            } else {
                // No URL parameters - check localStorage
                var savedPosition = localStorage.getItem('artOfWarPosition');
                if (savedPosition) {
                    var pos = JSON.parse(savedPosition);
                    app.currentWeek = pos.week;
                    app.currentTranslation = pos.translation;
                }
            }

            // Apply saved theme
            setTheme(currentTheme);
            
            render();
        }

        // LEARNING NOTE: Connect button clicks to functions
        document.getElementById('prevBtn').onclick = previousChapter;
        document.getElementById('nextBtn').onclick = nextChapter;
        document.getElementById('saveBtn').onclick = saveEntry;
        document.getElementById('exportBtn').onclick = exportCSV;
        document.getElementById('themeToggleBtn').onclick = toggleTheme;
        document.getElementById('manualChapterBtn').onclick = manualChapter;
        
        // Allow pressing Enter in the week number input to jump to that week
        document.getElementById('manualChapter').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                manualChapter();
            }
        });
        
        // Start the app!
        init();
    </script>
</body>
</html>
