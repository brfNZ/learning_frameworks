<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art of War - 52 Week Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(to bottom right, #1e293b, #334155, #0f172a); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 48px; margin-bottom: 10px; color: white; }
        .header h2 { font-size: 28px; font-weight: bold; color: white; margin-bottom: 8px; }
        .header p { color: #cbd5e1; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }
        .card { background: #475569; border-radius: 12px; padding: 30px; box-shadow: 0 20px 25px rgba(0,0,0,0.3); border: 1px solid #64748b; }
        .passage-display { text-align: center; padding: 20px; background: #334155; border-radius: 8px; margin-bottom: 20px; }
        .week-number { font-size: 20px; margin-bottom: 10px; color: white; }
        .passage-title { color: #fbbf24; font-size: 36px; font-weight: bold; line-height: 1.3; }
        .passage-chapter { color: #cbd5e1; font-size: 14px; margin-top: 10px; }
        .context-indicator { 
            color: #94a3b8; 
            font-size: 12px; 
            margin-top: 8px; 
            font-style: italic; 
        }
        
        /* NEW: Contextual indicator for Wing's multi-week chapters */
        .context-indicator { 
            color: #94a3b8; 
            font-size: 12px; 
            margin-top: 8px; 
            font-style: italic; 
        }
        
        .verse-display { padding: 20px; background: #1e293b; border-radius: 8px; margin-top: 15px; cursor: pointer; transition: all 0.2s; }
        .verse-display:hover { background: #2d3748; }
        .verse-author { color: #94a3b8; font-size: 11px; font-style: italic; margin-bottom: 12px; }
        .verse-text { color: #e2e8f0; font-size: 14px; line-height: 1.7; white-space: pre-line; max-height: 400px; overflow-y: auto; text-align: left; }
        .button-group { display: flex; gap: 12px; margin-bottom: 20px; }
        button { font-weight: bold; padding: 12px 16px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .next-btn { background: #b45309; color: white; flex: 1; }
        .next-btn:hover { background: #92400e; }
        .reset-btn { background: #64748b; color: white; flex: 1; }
        .reset-btn:hover { background: #475569; }
        .save-btn { background: #059669; color: white; width: 100%; margin-bottom: 12px; }
        .save-btn:hover { background: #047857; }
        .export-btn { background: #7c3aed; color: white; width: 100%; }
        .export-btn:hover { background: #6d28d9; }
        textarea { width: 100%; height: 200px; padding: 12px; background: #334155; color: white; border: 1px solid #64748b; border-radius: 8px; font-family: system-ui; font-size: 14px; resize: vertical; }
        textarea::placeholder { color: #94a3b8; }
        input[type="number"] { padding: 10px; background: #1e293b; color: white; border: 1px solid #64748b; border-radius: 6px; font-size: 14px; }
        .journal-section h3 { color: white; margin-bottom: 12px; font-size: 16px; }
        .manual-week { display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 20px; padding: 12px; background: #334155; border-radius: 8px; }
        .entries-list { max-height: 400px; overflow-y: auto; margin-bottom: 12px; }
        .entry-item { background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid #64748b; transition: all 0.2s; }
        .entry-item:hover { background: #3f4a5c; border-color: #fbbf24; }
        .entry-week { color: #fbbf24; font-weight: bold; font-size: 14px; }
        .entry-passage { color: #cbd5e1; font-size: 12px; margin: 4px 0; }
        .entry-preview { color: #cbd5e1; font-size: 12px; }
        .footer { text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚔</h1>
            <h2>Art of War</h2>
            <p>52-Week Strategy Study</p>
        </div>

        <div class="main">
            <div class="card">
                <div id="combinedDisplay"></div>
                <div class="button-group">
                    <button class="next-btn" id="nextBtn">Next</button>
                    <button class="reset-btn" id="resetBtn">Reset</button>
                </div>
            </div>
            
            <div class="card journal-section">
                <h3>Journal Entry</h3>
                <textarea id="journalText" placeholder="Write your reflections on this week's passage..."></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
                    <button class="save-btn" id="saveBtn">Save Entry</button>
                    <button class="export-btn" id="exportBtn">Export to CSV</button>
                </div>

                <div class="manual-week">
                    <input type="number" id="manualWeek" min="1" max="52" placeholder="Jump to week (1-52)">
                    <button id="manualWeekBtn" style="background: #059669; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap;">Go to Week</button>
                </div>
                
                <h3>Past Entries</h3>
                <div class="entries-list" id="entriesList"></div>
            </div>
        </div>

        <p class="footer">Study The Art of War through multiple translations. Click the verse text to switch translations.</p>
    </div>

    <!-- STEP 1: Load the translation verse files -->
    <script src="war-verses/verses-giles.js"></script>
    <script src="war-verses/verses-wing.js"></script>
    
    <!-- STEP 2: Load the main verses.js file (contains titles and helper functions) -->
    <script src="war-verses/verses.js"></script>
    
    <script>
        // LEARNING NOTE: The app object stores the current state of the application
        var app = {
            currentWeek: 1,              // Which week (1-52) we're on
            currentEditId: null,         // If editing an existing journal entry, store its index
            currentTranslation: "Giles", // Which translation to display (Giles or Wing)
            entries: []                  // Array of saved journal entries
        };

        // LEARNING NOTE: This function switches between available translations
        // It cycles through: Giles → Wing → back to Giles
        function cycleTranslation() {
            var translations = Object.keys(verseTexts);           // Get all available translations ["Giles", "Wing"]
            var currentIndex = translations.indexOf(app.currentTranslation);  // Find which one we're on
            var nextIndex = (currentIndex + 1) % translations.length;         // Calculate next (% wraps around)
            app.currentTranslation = translations[nextIndex];     // Update to next translation
            render();                                              // Re-draw the screen
        }

        // LEARNING NOTE: This is the main function that updates what you see on screen
        function render() {
            // STEP 1: Get information about the current week
            var weekInfo = getWeekInfo(app.currentWeek, app.currentTranslation);
            var weekTitle = getWeekTitle(app.currentWeek, app.currentTranslation);
            
            // STEP 2: Build the top display (week number + title + chapter)
            var display = '<div class="passage-display">';
            display += '<div class="week-number">Week ' + app.currentWeek + '</div>';
            display += '<div class="passage-title">' + weekTitle + '</div>';
            display += '<div class="passage-chapter">Chapter ' + weekInfo.chapter + '</div>';
            
            // STEP 3: Add contextual indicator for Wing (shows "Week X of 4")
            if (weekInfo.section !== null) {
                display += '<div class="context-indicator">Week ' + weekInfo.section + ' of 4</div>';
            }
            
            display += '</div>';
            document.getElementById('passageDisplay').innerHTML = display;

            // STEP 4: Display the verse text
            // Build the key to look up the verse (e.g., "1" for Giles or "1-2" for Wing)
            var verseKey = weekInfo.chapter.toString();
            if (weekInfo.section !== null) {
                verseKey += '-' + weekInfo.section;  // For Wing: "1-2" means Chapter 1, Section 2
            }
            
            // Check if we have verse text for this translation and key
            if (typeof verseTexts !== 'undefined' && 
                verseTexts[app.currentTranslation] && 
                verseTexts[app.currentTranslation][verseKey]) {
                
                var verseText = verseTexts[app.currentTranslation][verseKey];
                
                // Get the chapter title for this translation
                var chapterTitle;
                if (app.currentTranslation === "Wing") {
                    chapterTitle = chapterTitlesWing[weekInfo.chapter - 1];  // Arrays are 0-indexed
                } else {
                    chapterTitle = chapterTitlesGiles[weekInfo.chapter - 1];
                }
                
                // Build the verse display HTML
                var verseHTML = '<div class="verse-display" onclick="cycleTranslation()">' +
                    '<div class="verse-author">Translation: ' + app.currentTranslation + '</div>' +
                    '<div style="color: #fbbf24; font-size: 18px; font-weight: bold; margin-bottom: 12px;">Chapter ' + weekInfo.chapter + ': ' + chapterTitle + '</div>' +
                    '<div class="verse-text">' + verseText + '</div>' +
                    '</div>';
                
                document.getElementById('verseDisplay').innerHTML = verseHTML;
            } else {
                // No verse text available yet
                document.getElementById('verseDisplay').innerHTML = '';
            }

            // STEP 5: Display the list of saved journal entries
            var listHTML = '';
            for (var i = app.entries.length - 1; i >= 0; i--) {  // Loop backwards to show newest first
                var e = app.entries[i];
                listHTML += '<div class="entry-item" onclick="loadEntry(' + i + ')">' +
                    '<div class="entry-week">Week ' + e.week + ' - ' + e.title + '</div>' +
                    '<div class="entry-passage">Chapter ' + e.chapter + '</div>' +
                    '<div class="entry-preview">' + e.text.substring(0, 50) + '...</div>' +
                    '</div>';
            }
            document.getElementById('entriesList').innerHTML = listHTML;
        }

        // LEARNING NOTE: Move to the next week
        function nextWeek() {
            if (app.currentWeek < 52) {
                app.currentWeek++;
                app.currentEditId = null;  // Clear any editing state
                document.getElementById('journalText').value = '';  // Clear the text box
                render();
            }
        }

        // LEARNING NOTE: Jump to a specific week number
        function manualWeek() {
            var num = parseInt(document.getElementById('manualWeek').value);
            if (isNaN(num) || num < 1 || num > 52) {
                alert('Enter a week number between 1 and 52');
                return;
            }
            app.currentWeek = num;
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            document.getElementById('manualWeek').value = '';
            render();
        }

        // LEARNING NOTE: Save a journal entry
        function saveEntry() {
            var weekInfo = getWeekInfo(app.currentWeek, app.currentTranslation);
            var weekTitle = getWeekTitle(app.currentWeek, app.currentTranslation);
            var text = document.getElementById('journalText').value;
            var now = new Date().toISOString().split('T')[0];  // Get today's date in YYYY-MM-DD format

            // Either update an existing entry or create a new one
            if (app.currentEditId !== null) {
                app.entries[app.currentEditId].text = text;
            } else {
                app.entries.push({ 
                    week: app.currentWeek, 
                    chapter: weekInfo.chapter, 
                    title: weekTitle, 
                    date: now, 
                    text: text 
                });
            }
            
            // Save to browser's localStorage so entries persist between sessions
            localStorage.setItem('artOfWarEntries', JSON.stringify(app.entries));
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            alert('Entry saved!');
            render();
        }

        // LEARNING NOTE: Load an existing journal entry for editing
        function loadEntry(idx) {
            app.currentEditId = idx;
            document.getElementById('journalText').value = app.entries[idx].text;
        }

        // LEARNING NOTE: Export all entries to a CSV file
        function exportCSV() {
            var csv = 'Date,Week,Chapter,Passage,Notes\n';
            for (var i = 0; i < app.entries.length; i++) {
                var e = app.entries[i];
                var notes = e.text.replace(/"/g, '""').replace(/\n/g, ' ');  // Escape quotes and remove line breaks
                csv += e.date + ',' + e.week + ',' + e.chapter + ',"' + e.title + '","' + notes + '"\n';
            }
            
            // Create a downloadable file
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'art-of-war-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // LEARNING NOTE: Initialize the app when page loads
        function init() {
            var saved = localStorage.getItem('artOfWarEntries');
            if (saved) app.entries = JSON.parse(saved);  // Load saved entries from localStorage
            render();
        }

        // LEARNING NOTE: Connect button clicks to functions
        document.getElementById('nextBtn').onclick = nextWeek;
        document.getElementById('resetBtn').onclick = function() { 
            app.currentWeek = 1; 
            app.currentEditId = null; 
            document.getElementById('journalText').value = ''; 
            render(); 
        };
        document.getElementById('saveBtn').onclick = saveEntry;
        document.getElementById('exportBtn').onclick = exportCSV;
        document.getElementById('manualWeekBtn').onclick = manualWeek;
        
        // Allow pressing Enter in the week number input to jump to that week
        document.getElementById('manualWeek').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                manualWeek();
            }
        });

        // Start the app!
        init();
    </script>
</body>
</html>
