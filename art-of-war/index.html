<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Art of War - 52 Week Tracker</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(to bottom right, #1e293b, #334155, #0f172a); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 48px; margin-bottom: 10px; color: white; }
        .header h2 { font-size: 28px; font-weight: bold; color: white; margin-bottom: 8px; }
        .header p { color: #cbd5e1; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }
        .card { background: #475569; border-radius: 12px; padding: 30px; box-shadow: 0 20px 25px rgba(0,0,0,0.3); border: 1px solid #64748b; }
        .passage-display { text-align: center; padding: 20px; background: #334155; border-radius: 8px; margin-bottom: 20px; }
        .week-number { font-size: 20px; margin-bottom: 10px; color: white; }
        .passage-title { color: #fbbf24; font-size: 36px; font-weight: bold; line-height: 1.3; }
        .passage-chapter { color: #fbbf24; font-size: 14px; margin-top: 10px; }
        .context-indicator { 
            color: #94a3b8; 
            font-size: 12px; 
            margin-top: 8px; 
            font-style: italic; 
        }
        
        /* NEW: Contextual indicator for Wing's multi-week chapters */
        .context-indicator { 
            color: #94a3b8; 
            font-size: 12px; 
            margin-top: 8px; 
            font-style: italic; 
        }
        
        .verse-display { padding: 20px; background: #1e293b; border-radius: 8px; margin-top: 15px; cursor: pointer; transition: all 0.2s; }
        .verse-display:hover { background: #2d3748; }
        .verse-author { color: #94a3b8; font-size: 11px; font-style: italic; margin-bottom: 12px; }
        .verse-text { color: #94a3b8; font-size: 14px; line-height: 1.7; white-space: pre-line; max-height: 400px; overflow-y: auto; text-align: left; }        .button-group { display: flex; gap: 12px; margin-bottom: 20px; }
        button { font-weight: bold; padding: 12px 16px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .next-btn { background: #b45309; color: white; flex: 1; }
        .next-btn:hover { background: #92400e; }
        .reset-btn { background: #b45309; color: white; flex: 1; }
        .reset-btn:hover { background: #92400e; }
        .save-btn { background: #059669; color: white; width: 100%; margin-bottom: 12px; }
        .save-btn:hover { background: #047857; }
        .export-btn { background: #7c3aed; color: white; width: 100%; }
        .export-btn:hover { background: #6d28d9; }
        textarea { width: 100%; height: 200px; padding: 12px; background: #334155; color: white; border: 1px solid #64748b; border-radius: 8px; font-family: system-ui; font-size: 14px; resize: vertical; }
        textarea::placeholder { color: #94a3b8; }
        input[type="text"] { padding: 10px; background: #1e293b; color: white; border: 1px solid #64748b; border-radius: 8px; font-size: 14px; }
        .journal-section h3 { color: white; margin-bottom: 12px; font-size: 16px; }
        .manual-week { display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 20px; padding: 12px; background: #334155; border-radius: 8px; }
        .entries-list { max-height: 400px; overflow-y: auto; margin-bottom: 12px; }
        .entry-header { display: flex; gap: 8px; align-items: baseline; margin-bottom: 2px; }
        .entry-item { background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid #64748b; transition: all 0.2s; }
        .entry-item:hover { background: #3f4a5c; border-color: #fbbf24; }
        .entry-chapter-ref { color: #94a3b8; font-size: 13px; font-weight: 500; }
        .entry-date { color: #64748b; font-size: 11px; margin: 2px 0 8px 0; }
        .entry-title { color: #fbbf24; font-size: 14px; margin-bottom: 6px; }
        .entry-preview { color: #e2e8f0; font-size: 11px; }        
        .footer { text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚔</h1>
            <h2>Art of War</h2>
            <p>52-Week Strategy Study</p>
        </div>

        <div class="main">
            <div class="card">
                <div id="combinedDisplay"></div>
                    <div class="button-group">
                        <button class="reset-btn" id="prevBtn">Previous</button>
                        <button class="next-btn" id="nextBtn">Next</button>
                    </div>
            </div>
            
            <div class="card journal-section">
                <h3>Journal Entry</h3>
                <textarea id="journalText" placeholder="Write your reflections on this week's passage..."></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
                    <button class="save-btn" id="saveBtn">Save Entry</button>
                    <button class="export-btn" id="exportBtn">Export to CSV</button>
                </div>

                <div class="manual-week">
                    <input type="text" id="manualChapter" placeholder="Jump to Ch.1 or 2-3">
                    <button id="manualChapterBtn" style="...">Go to Chapter</button>  
                </div>
                
                <h3>Past Entries</h3>
                <div class="entries-list" id="entriesList"></div>
            </div>
        </div>

        <p class="footer">Study The Art of War through multiple translations. Click the verse text to switch translations.</p>
    </div>

    <!-- STEP 1: Load the translation verse files -->
    <script src="war-verses/verses-giles.js"></script>
    <script src="war-verses/verses-wing.js"></script>
    
    <!-- STEP 2: Load the main verses.js file (contains titles and helper functions) -->
    <script src="war-verses/verses.js"></script>
    
    <script>
        // LEARNING NOTE: The app object stores the current state of the application
        var app = {
            currentWeek: 1,              // Which week (1-52) we're on
            currentEditId: null,         // If editing an existing journal entry, store its index
            currentTranslation: "Giles", // Which translation to display (Giles or Wing)
            entries: []                  // Array of saved journal entries
        };

        // LEARNING NOTE: This function switches between available translations
        // It cycles through: Giles → Wing → back to Giles
        function cycleTranslation() {
            var translations = Object.keys(verseTexts);           // Get all available translations ["Giles", "Wing"]
            var currentIndex = translations.indexOf(app.currentTranslation);  // Find which one we're on
            var nextIndex = (currentIndex + 1) % translations.length;         // Calculate next (% wraps around)
            app.currentTranslation = translations[nextIndex];     // Update to next translation
            render();                                              // Re-draw the screen
        }

        // LEARNING NOTE: This is the main function that updates what you see on screen
        function render() {
            // STEP 1: Get information about the current chapter/part
            var weekInfo = getWeekInfo(app.currentWeek, app.currentTranslation);
            var weekTitle = getWeekTitle(app.currentWeek, app.currentTranslation);
            
            // STEP 2: Build the verse key to look up the text
            var verseKey = weekInfo.chapter.toString();
            if (weekInfo.section !== null) {
                verseKey += '-' + weekInfo.section;
            }
            
            // STEP 3: Get chapter title for this translation
            var chapterTitle;
            if (app.currentTranslation === "Wing") {
                chapterTitle = chapterTitlesWing[weekInfo.chapter - 1];
            } else {
                chapterTitle = chapterTitlesGiles[weekInfo.chapter - 1];
            }
            
            // STEP 4: Build the combined display
            var display = '<div class="verse-display" onclick="cycleTranslation()">';
            
            // Translation label
            display += '<div class="verse-author">Translation: ' + app.currentTranslation + '</div>';
            
            // Chapter number
            display += '<div style="color: #cbd5e1; font-size: 16px; margin-top: 12px;">Chapter ' + weekInfo.chapter + '</div>';
            
            // Chapter title
            display += '<div style="color: #fbbf24; font-size: 28px; font-weight: bold; margin-top: 4px;">' + chapterTitle + '</div>';
            
            // For Wing: show Part number and Part title
            if (weekInfo.section !== null) {
                display += '<div style="color: #cbd5e1; font-size: 16px; margin-top: 8px;">Part ' + weekInfo.section + '</div>';
                display += '<div style="color: #fbbf24; font-size: 24px; font-weight: bold; margin-top: 4px;">' + weekTitle + '</div>';
            }
            
            // Separator line
            display += '<div style="border-top: 1px solid #64748b; margin: 20px 0;"></div>';
            
            // STEP 5: Add the verse text if available
            if (typeof verseTexts !== 'undefined' && 
                verseTexts[app.currentTranslation] && 
                verseTexts[app.currentTranslation][verseKey]) {
                
                var verseText = verseTexts[app.currentTranslation][verseKey];
                display += '<div class="verse-text">' + verseText + '</div>';
            } else {
                display += '<div class="verse-text" style="color: #94a3b8; font-style: italic;">Verse text not yet added</div>';
            }
            
            display += '</div>';
            
            // Update the combined display
            document.getElementById('combinedDisplay').innerHTML = display;
        
            // STEP 6: Display the list of saved journal entries
            var listHTML = '';
            for (var i = app.entries.length - 1; i >= 0; i--) {
                var e = app.entries[i];
                
                // Build chapter reference
                var chapterRef = 'Ch ' + e.chapter;
                if (e.section) {
                    chapterRef += ', Pt ' + e.section;
                }
                chapterRef += ' (' + e.translation + ')';
                
                listHTML += '<div class="entry-item" onclick="loadEntry(' + i + ')">' +
                    '<div class="entry-header">' +
                        '<span class="entry-chapter-ref">' + chapterRef + '</span>' +
                        '<span class="entry-title">' + e.title + '</span>' +
                    '</div>' +
                    '<div class="entry-date">' + e.date + '</div>' +
                    '<div class="entry-preview">' + e.text.substring(0, 60) + '...</div>' +
                    '</div>';
            }
            document.getElementById('entriesList').innerHTML = listHTML;
                        
            // Save current position to localStorage
            localStorage.setItem('artOfWarPosition', JSON.stringify({
                week: app.currentWeek,
                translation: app.currentTranslation
            }));

            // Update URL without reloading page
            var weekInfo = getWeekInfo(app.currentWeek, app.currentTranslation);
            var chapterParam = weekInfo.chapter.toString();
            if (weekInfo.section !== null) {
                chapterParam += '-' + weekInfo.section;
            }
            var newUrl = window.location.pathname + '?ch=' + chapterParam + '&tr=' + app.currentTranslation;
            window.history.replaceState({}, '', newUrl);
                    }
                
        // LEARNING NOTE: Move to the next week
        function nextChapter() {
            if (app.currentWeek < 52) {
                app.currentWeek++;
                app.currentEditId = null;  // Clear any editing state
                document.getElementById('journalText').value = '';  // Clear the text box
                render();
            }
        }

        function previousChapter() {
            if (app.currentWeek > 1) {
                app.currentWeek--;
                app.currentEditId = null;
                document.getElementById('journalText').value = '';
                render();
            }
        }

        // LEARNING NOTE: Jump to a specific chapter number
        function manualChapter() {
            var input = document.getElementById('manualChapter').value.trim();
            
            // Parse input: "2" or "2-3"
            var parts = input.split('-');
            var chapter = parseInt(parts[0]);
            var section = parts[1] ? parseInt(parts[1]) : 1;
            
            // Validate chapter number (1-13)
            if (isNaN(chapter) || chapter < 1 || chapter > 13) {
                alert('Enter a chapter number between 1 and 13 (e.g., 5 or 5-2)');
                return;
            }
            
            // Validate section number if provided (1-4)
            if (parts[1] && (isNaN(section) || section < 1 || section > 4)) {
                alert('Part number must be between 1 and 4 (e.g., 2-3)');
                return;
            }
            
            // Convert chapter-section to week number
            // For Wing (or when section specified): week = (chapter-1)*4 + section
            // For Giles (when no section): week = chapter
            if (section > 1 || app.currentTranslation === 'Wing') {
                app.currentWeek = (chapter - 1) * 4 + section;
            } else {
                app.currentWeek = chapter;
            }
            
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            document.getElementById('manualChapter').value = '';
            render();
        }
                
        // LEARNING NOTE: Save a journal entry
        function saveEntry() {
            var weekInfo = getWeekInfo(app.currentWeek, app.currentTranslation);
            var weekTitle = getWeekTitle(app.currentWeek, app.currentTranslation);
            var text = document.getElementById('journalText').value;
            var now = new Date().toISOString().split('T')[0];  // Get today's date in YYYY-MM-DD format

            // Either update an existing entry or create a new one
            if (app.currentEditId !== null) {
                app.entries[app.currentEditId].text = text;
            } else {
              app.entries.push({ 
                chapter: weekInfo.chapter,
                section: weekInfo.section,  // Will be null for Giles
                translation: app.currentTranslation,
                title: weekTitle, 
                date: now, 
                text: text 
            });
            }
            
            // Save to browser's localStorage so entries persist between sessions
            localStorage.setItem('artOfWarEntries', JSON.stringify(app.entries));
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            alert('Entry saved!');
            render();
        }

        // LEARNING NOTE: Load an existing journal entry for editing
        function loadEntry(idx) {
            app.currentEditId = idx;
            document.getElementById('journalText').value = app.entries[idx].text;
        }

        // LEARNING NOTE: Export all entries to a CSV file
        function exportCSV() {
            var csv = 'Date,Week,Chapter,Passage,Notes\n';
            for (var i = 0; i < app.entries.length; i++) {
                var e = app.entries[i];
                var notes = e.text.replace(/"/g, '""').replace(/\n/g, ' ');  // Escape quotes and remove line breaks
                csv += e.date + ',' + e.week + ',' + e.chapter + ',"' + e.title + '","' + notes + '"\n';
            }
            
            // Create a downloadable file
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'art-of-war-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        // LEARNING NOTE: Initialize the app when page loads
          function init() {
            // Load saved journal entries
            var saved = localStorage.getItem('artOfWarEntries');
            if (saved) app.entries = JSON.parse(saved);
            
            // Check URL parameters first (higher priority)
            var urlParams = new URLSearchParams(window.location.search);
            var urlChapter = urlParams.get('ch');
            var urlTranslation = urlParams.get('tr');
            
            if (urlChapter) {
                // URL has chapter parameter - use it
                // Parse "2-3" format or just "2"
                var parts = urlChapter.split('-');
                var chapter = parseInt(parts[0]);
                var section = parts[1] ? parseInt(parts[1]) : 1;
                
                // Convert chapter-section to week number
                if (urlTranslation === 'Wing' || section > 1) {
                    app.currentWeek = (chapter - 1) * 4 + section;
                } else {
                    app.currentWeek = chapter;
                }
                
                if (urlTranslation) {
                    app.currentTranslation = urlTranslation;
                }
            } else {
                // No URL parameters - check localStorage
                var savedPosition = localStorage.getItem('artOfWarPosition');
                if (savedPosition) {
                    var pos = JSON.parse(savedPosition);
                    app.currentWeek = pos.week;
                    app.currentTranslation = pos.translation;
                }
            }
            
            render();
        }

        // LEARNING NOTE: Connect button clicks to functions
        document.getElementById('prevBtn').onclick = previousChapter;
        document.getElementById('nextBtn').onclick = nextChapter;
        document.getElementById('saveBtn').onclick = saveEntry;
        document.getElementById('exportBtn').onclick = exportCSV;
        document.getElementById('manualChapterBtn').onclick = manualChapter;
        
        // Allow pressing Enter in the week number input to jump to that week
        document.getElementById('manualChapter').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                manualChapter();
            }
        });
        
        // Start the app!
        init();
    </script>
</body>
</html>
