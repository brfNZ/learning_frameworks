<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tao Te Ching - Journal & Divination</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: linear-gradient(to bottom right, #1e293b, #334155, #0f172a); min-height: 100vh; font-family: system-ui, -apple-system, sans-serif; padding: 20px; }
        .container { max-width: 900px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 40px; }
        .header h1 { font-size: 60px; margin-bottom: 10px; }
        .header h2 { font-size: 36px; font-weight: bold; color: white; margin-bottom: 8px; }
        .header p { color: #cbd5e1; }
        .main { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        @media (max-width: 1000px) { .main { grid-template-columns: 1fr; } }
        .card { background: #475569; border-radius: 12px; padding: 30px; box-shadow: 0 20px 25px rgba(0,0,0,0.3); border: 1px solid #64748b; }
        .lines-display { display: flex; flex-direction: column; align-items: center; margin-bottom: 30px; gap: 4px; }
        .line-segment { background-color: white; height: 12px; display: inline-block; }
        .solid { width: 80px; }
        .broken-line { display: flex; gap: 16px; justify-content: center; }
        .broken-segment { width: 32px; }
        .dashed-line { display: flex; gap: 10px; justify-content: center; }
        .dashed-segment { width: 20px; }
        .verse-display { text-align: center; padding: 20px; background: #334155; border-radius: 8px; margin-bottom: 20px; }
        .verse-number { font-size: 24px; margin-bottom: 12px; color: white; }
        .verse-title { color: #fbbf24; font-size: 42px; font-weight: bold; }
        .instruction { text-align: center; padding: 20px; background: #334155; border-radius: 8px; margin-bottom: 20px; color: #cbd5e1; font-size: 14px; }
        .button-group { display: flex; gap: 12px; margin-bottom: 20px; }
        button { font-weight: bold; padding: 12px 16px; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s; }
        .generate-btn { background: #b45309; color: white; flex: 1; }
        .generate-btn:hover { background: #92400e; }
        .reset-btn { background: #64748b; color: white; flex: 1; }
        .reset-btn:hover { background: #475569; }
        .save-btn { background: #059669; color: white; width: 100%; }
        .save-btn:hover { background: #047857; }
        .export-btn { background: #7c3aed; color: white; width: 100%; }
        .export-btn:hover { background: #6d28d9; }
        textarea { width: 100%; height: 200px; padding: 12px; background: #334155; color: white; border: 1px solid #64748b; border-radius: 8px; font-family: system-ui; font-size: 14px; resize: vertical; }
        textarea::placeholder { color: #94a3b8; }
        input[type="text"], input[type="number"] { padding: 10px; background: #1e293b; color: white; border: 1px solid #64748b; border-radius: 6px; font-size: 14px; }
        .journal-section h3 { color: white; margin-bottom: 12px; font-size: 16px; }
        .manual-entry { display: grid; grid-template-columns: 1fr auto; gap: 12px; margin-bottom: 20px; padding: 12px; background: #334155; border-radius: 8px; }
        .entries-list { max-height: 400px; overflow-y: auto; margin-bottom: 12px; }
        .entry-item { background: #334155; padding: 12px; border-radius: 8px; margin-bottom: 8px; cursor: pointer; border: 1px solid #64748b; transition: all 0.2s; }
        .entry-item:hover { background: #3f4a5c; border-color: #fbbf24; }
        .entry-date { color: #cbd5e1; font-size: 12px; }
        .entry-verse { color: #fbbf24; font-weight: bold; font-size: 14px; }
        .entry-preview { color: #cbd5e1; font-size: 12px; margin-top: 4px; }
        .footer { text-align: center; color: #64748b; font-size: 12px; margin-top: 30px; }
        .line-codes { text-align: center; color: #94a3b8; font-size: 12px; margin-top: 8px; font-family: monospace; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>â˜¯</h1>
            <h2>Tao Te Ching</h2>
            <p>Journal & I Ching Divination</p>
        </div>

        <div class="main">
            <div class="card">
                <div class="lines-display" id="linesDisplay"></div>
                 <div class="line-codes" id="lineCodesDisplay"></div>
                <div id="verseDisplay"></div>
               
                <div class="button-group">
                    <button class="generate-btn" id="genBtn">Generate</button>
                    <button class="reset-btn" id="resetBtn">Reset</button>
                </div>
            </div>

            <div class="card journal-section">
                <h3>Journal Entry</h3>
                <textarea id="journalText" placeholder="Write your reflections here..."></textarea>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin: 12px 0;">
                    <button class="save-btn" id="saveBtn">Save Entry</button>
                    <button class="export-btn" id="exportBtn">Export to CSV</button>
                </div>

                <div class="manual-entry">
                    <input type="text" id="manualVerse" placeholder="Verse # (1-81) or Lines (1120)">
                    <button id="manualEntryBtn" style="background: #059669; color: white; padding: 10px 16px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; white-space: nowrap;">Manual Entry</button>
                </div>
                
                <h3>Past Entries</h3>
                <div class="entries-list" id="entriesList"></div>
            </div>
        </div>

        <p class="footer">Use this to randomly select a verse and journal your reflections</p>
    </div>

    <script>
        var verseTitles = ["The Beginning of Power", "Using Polarity", "Keeping Peace", "The Nature of the Tao", "Holding to the Center", "Perceiving the Subtle", "The Power of Selflessness", "Noncompetitive Values", "Transcending Decline", "Inner Harmony", "Using What Is Not", "Controlling the Senses", "Expanding Identification", "The Essence of Tao", "The Power in Subtle Force", "Knowing the Absolute", "The Way of Subtle Influence", "Losing the Instincts", "Return to Simplicity", "Developing Independence", "Knowing the Collective Origin", "Following the Pattern", "The Steady Force of Attitude", "Nature rarely speaks", "The Tao of Greatness", "The Gravity of Power", "The Skillful Exchange of Information", "Uniting the Forces", "The Way of Noninterference", "Leading the Leader", "The Use of Force", "The Limits of Specialization", "Self-Mastery", "The Evolving Tao", "Sensing the Insensible", "Concealing the Advantage", "The Power in Desirelessness", "Power Without Motive", "Oneness in Leadership", "The Way", "Mastering the Paradox", "Knowing Polarity", "Subtle Powers", "The Power in Needing Less", "Using Emptiness", "Knowing Enough", "Cultivating Inner-Knowledge", "The Art of Nonaction", "Opening the Mind", "The Art of Survival", "The Power of Impartial Support", "Returning to Insight", "The Undivided Path", "Establishing a Universal View", "The Power in Not Contending", "Gaining Oneness", "The Power in Effortlessness", "Cultivating the Center", "The Way of Moderation", "Holding the Position", "The Power in Modesty", "The Tao in Leaders", "The Path of Least Resistance", "The Power at the Beginning", "The Danger in Cleverness", "The Power in Staying Low", "The Power in Compassion", "Nonaggressive Strength", "Neutralizing Escalation", "Knowing the Tao", "Knowing the Disease", "The Appropriate Perspective", "Nature's Way", "Unnatural Authority", "Self-Destructive Leadership", "The Power in Flexibility", "Directing the Power", "Accepting the Blame", "The Power In Not Taking Advantage", "Fulfilling Independence", "The Evolved Way"];

        var app = {
            lines: [null, null, null, null],
            verseNumber: null,
            currentEditId: null,
            entries: []
        };

        function getLineHTML(type) {
            if (type === 0) return '<div class="line-segment solid"></div>';
            if (type === 1) return '<div class="broken-line"><div class="line-segment broken-segment"></div><div class="line-segment broken-segment"></div></div>';
            if (type === 2) return '<div class="dashed-line"><div class="line-segment dashed-segment"></div><div class="line-segment dashed-segment"></div><div class="line-segment dashed-segment"></div></div>';
            return '<div class="dashed-line" style="opacity:0.3"><div class="line-segment dashed-segment"></div><div class="line-segment dashed-segment"></div><div class="line-segment dashed-segment"></div></div>';
        }

        function cycleLine(index, direction) {
            if (app.lines[index] === null) {
                app.lines[index] = 0;
            } else {
                if (direction === 'forward') {
                    app.lines[index] = (app.lines[index] + 1) % 3;
                } else {
                    app.lines[index] = (app.lines[index] + 2) % 3; // +2 is same as -1 in mod 3
                }
            }
            
            // Recalculate verse if all lines are set
            if (app.lines.every(function(l) { return l !== null; })) {
                var base3 = app.lines[0] * 27 + app.lines[1] * 9 + app.lines[2] * 3 + app.lines[3];
                app.verseNumber = base3 + 1;
            }
            render();
        }

        function render() {
            var linesHTML = '';
            var lineCodesHTML = '';
            var verseHTML = '';
            
            for (var i = 0; i < 4; i++) {
                linesHTML += '<div onclick="cycleLine(' + i + ', \'forward\')" oncontextmenu="cycleLine(' + i + ', \'backward\'); return false;" style="cursor: pointer; padding: 1px 0;">' + getLineHTML(app.lines[i]) + '</div>';
            }
            document.getElementById('linesDisplay').innerHTML = linesHTML;

            if (app.verseNumber !== null) {
                var title = verseTitles[app.verseNumber - 1];
                verseHTML = '<div class="verse-display"><div class="verse-number">Verse ' + app.verseNumber + '</div><div class="verse-title">' + title + '</div></div>';
                
                // Display the line values
                var lineStr = '';
                for (var i = 0; i < 4; i++) {
                    lineStr += (app.lines[i] !== null ? app.lines[i] : '?');
                }
                lineCodesHTML = 'Lines (top to bottom): ' + lineStr;
                document.getElementById('lineCodesDisplay').innerHTML = lineCodesHTML;
            } else {
                verseHTML = '<div class="instruction">Click "Generate" to cast your divination and receive a verse for meditation</div>';
            }
            document.getElementById('verseDisplay').innerHTML = verseHTML;

            var listHTML = '';
            for (var i = app.entries.length - 1; i >= 0; i--) {
                var e = app.entries[i];
                listHTML += '<div class="entry-item" onclick="loadEntry(' + i + ')"><div class="entry-date">' + e.date + '</div><div class="entry-verse">Verse ' + e.verse + ' - ' + e.title + '</div><div class="entry-preview">' + e.text.substring(0, 50) + '...</div></div>';
            }
            document.getElementById('entriesList').innerHTML = listHTML;
        }

        function generate() {
            // Generate 4 random lines (0=solid, 1=broken, 2=double-broken)
            app.lines = [
                Math.floor(Math.random() * 3), 
                Math.floor(Math.random() * 3), 
                Math.floor(Math.random() * 3), 
                Math.floor(Math.random() * 3)
            ];
            
            // Calculate verse number reading TOP TO BOTTOM
            // Lines are stored in array as [0]=top, [1]=2nd, [2]=3rd, [3]=bottom
            var base3 = app.lines[0] * 27 + app.lines[1] * 9 + app.lines[2] * 3 + app.lines[3];
            app.verseNumber = base3 + 1;
            
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            render();
        }

        function verseToLines(verseNum) {
            // Convert verse number (1-81) back to line values (0-2)
            var base3 = verseNum - 1; // Convert to 0-80
            var lines = [];
            
            // Extract each digit in base-3
            lines[0] = Math.floor(base3 / 27); // Top line
            base3 = base3 % 27;
            
            lines[1] = Math.floor(base3 / 9); // 2nd line
            base3 = base3 % 9;
            
            lines[2] = Math.floor(base3 / 3); // 3rd line
            lines[3] = base3 % 3; // Bottom line
            
            return lines;
        }

        function manualEntry() {
            var input = document.getElementById('manualVerse').value.trim();
            
            // Check if it's a 4-digit line pattern (like "1120")
            if (input.length === 4 && /^[0-2]{4}$/.test(input)) {
                // Parse as line pattern
                app.lines = [
                    parseInt(input[0]),
                    parseInt(input[1]),
                    parseInt(input[2]),
                    parseInt(input[3])
                ];
                var base3 = app.lines[0] * 27 + app.lines[1] * 9 + app.lines[2] * 3 + app.lines[3];
                app.verseNumber = base3 + 1;
            } 
            // Otherwise treat as verse number
            else {
                var num = parseInt(input);
                if (isNaN(num) || num < 1 || num > 81) {
                    alert('Enter verse 1-81 or 4-digit line pattern (e.g., 1120)');
                    return;
                }
                app.verseNumber = num;
                app.lines = verseToLines(num);
            }
            
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            document.getElementById('manualVerse').value = '';
            render();
        }

        function saveEntry() {
            if (app.verseNumber === null) {
                alert('Generate or select a verse first');
                return;
            }
            var text = document.getElementById('journalText').value;
            var now = new Date().toISOString().split('T')[0];
            var title = verseTitles[app.verseNumber - 1];

            if (app.currentEditId !== null) {
                app.entries[app.currentEditId].text = text;
            } else {
                app.entries.push({ date: now, verse: app.verseNumber, title: title, text: text });
            }
            localStorage.setItem('taoEntries', JSON.stringify(app.entries));
            app.currentEditId = null;
            document.getElementById('journalText').value = '';
            alert('Entry saved!');
            render();
        }

        function loadEntry(idx) {
            app.currentEditId = idx;
            document.getElementById('journalText').value = app.entries[idx].text;
        }

        function exportCSV() {
            var csv = 'Date,Verse,Title,Notes\n';
            for (var i = 0; i < app.entries.length; i++) {
                var e = app.entries[i];
                var notes = e.text.replace(/"/g, '""').replace(/\n/g, ' ');
                csv += e.date + ',' + e.verse + ',"' + e.title + '","' + notes + '"\n';
            }
            var blob = new Blob([csv], { type: 'text/csv' });
            var url = URL.createObjectURL(blob);
            var a = document.createElement('a');
            a.href = url;
            a.download = 'tao-journal-' + new Date().toISOString().split('T')[0] + '.csv';
            a.click();
        }

        function init() {
            var saved = localStorage.getItem('taoEntries');
            if (saved) app.entries = JSON.parse(saved);
            render();
        }

        document.getElementById('genBtn').onclick = generate;
        document.getElementById('resetBtn').onclick = function() { app.lines = [null, null, null, null]; app.verseNumber = null; app.currentEditId = null; document.getElementById('journalText').value = ''; render(); };
        document.getElementById('saveBtn').onclick = saveEntry;
        document.getElementById('exportBtn').onclick = exportCSV;
        document.getElementById('manualEntryBtn').onclick = manualEntry;
        document.getElementById('manualVerse').onkeypress = function(e) {
            if (e.key === 'Enter') {
                manualEntry();
            }
        };

        init();
    </script>
</body>
</html>
