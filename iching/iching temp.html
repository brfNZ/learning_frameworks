<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching Hexagram Pages</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1, h2, h3 { text-align: center; }
        table { border-collapse: collapse; width: 100%; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .table-container { overflow-x: auto; }
        form { margin-bottom: 20px; }
        label { display: block; margin: 5px 0; }
        button { margin: 5px; }
        #divResult { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f9f9f9; }
    </style>
    
    <script>
    // Journal data and functions
    let journal = JSON.parse(localStorage.getItem('ichingJournal')) || [];

    function addEntry() {
      const question = document.getElementById('question').value;
      const hex = document.getElementById('hex').value;
      const notes = document.getElementById('notes').value;
      if (!question || !hex) return alert('Add question and hex!');
      
      const entry = {
        id: Date.now(),
        date: new Date().toISOString().split('T')[0],
        question: question,
        hex: hex,
        notes: notes
      };
      journal.unshift(entry);
      localStorage.setItem('ichingJournal', JSON.stringify(journal));
      displayJournal();
      clearForm();
    }

    function displayJournal() {
      const tbody = document.getElementById('journalBody');
      tbody.innerHTML = '';
      journal.forEach(entry => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${entry.date}</td>
          <td>${entry.question}</td>
          <td>${entry.hex}</td>
          <td>${entry.notes}</td>
          <td><button onclick="deleteEntry(${entry.id})">Delete</button></td>
        `;
      });
    }

    function deleteEntry(id) {
      journal = journal.filter(e => e.id !== id);
      localStorage.setItem('ichingJournal', JSON.stringify(journal));
      displayJournal();
    }

    function clearForm() {
      document.getElementById('question').value = '';
      document.getElementById('hex').value = '';
      document.getElementById('notes').value = '';
    }

    function exportJournal() {
      const csv = ['Date,Question,Hex,Notes'].concat(journal.map(e => `${e.date},"${e.question}",${e.hex},"${e.notes}"`)).join('\n');
      const blob = new Blob([csv], {type: 'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'iching-journal.csv'; a.click();
    }

    // PDF opener
    function openPDF(url) {
      window.open(url, '_blank');
    }

    // Load journal
    displayJournal();

    // Divination data
    const stems = [
      {num: 1, name: 'Jia'},
      {num: 2, name: 'Yi'},
      {num: 3, name: 'Bing'},
      {num: 4, name: 'Ding'},
      {num: 5, name: 'Wu'},
      {num: 6, name: 'Ji'},
      {num: 7, name: 'Geng'},
      {num: 8, name: 'Xin'},
      {num: 9, name: 'Ren'},
      {num: 10, name: 'Gui'},
      {num: 11, name: 'Jia (cycle)'},
      {num: 12, name: 'Yi (cycle)'}
    ];

    const trigrams = {
      1: {name: 'Qian', symbol: '☰'},
      2: {name: 'Dui', symbol: '☱'},
      3: {name: 'Li', symbol: '☲'},
      4: {name: 'Zhen', symbol: '☳'},
      5: {name: 'Xun', symbol: '☴'},
      6: {name: 'Kan', symbol: '☵'},
      7: {name: 'Gen', symbol: '☶'},
      8: {name: 'Kun', symbol: '☷'}
    };

    const hexSymbols = {
      1: '䷀', 2: '䷁', 3: '䷂', 4: '䷃', 5: '䷄', 6: '䷅', 7: '䷆', 8: '䷇', 9: '䷈', 10: '䷉',
      11: '䷊', 12: '䷋', 13: '䷌', 14: '䷍', 15: '䷎', 16: '䷏', 17: '䷐', 18: '䷑', 19: '䷒', 20: '䷓',
      21: '䷔', 22: '䷕', 23: '䷖', 24: '䷗', 25: '䷘', 26: '䷙', 27: '䷚', 28: '䷛', 29: '䷜', 30: '䷝',
      31: '䷞', 32: '䷟', 33: '䷠', 34: '䷡', 35: '䷢', 36: '䷣', 37: '䷤', 38: '䷥', 39: '䷦', 40: '䷧',
      41: '䷨', 42: '䷩', 43: '䷪', 44: '䷫', 45: '䷬', 46: '䷭', 47: '䷮', 48: '䷯', 49: '䷰', 50: '䷱',
      51: '䷲', 52: '䷳', 53: '䷴', 54: '䷵', 55: '䷶', 56: '䷷', 57: '䷸', 58: '䷹', 59: '䷺', 60: '䷻',
      61: '䷼', 62: '䷽', 63: '䷾', 64: '䷿'
    };

    // Sample tableData array (expand with your full 64; partial for Ni from your data)
    const tableData = [
      {gua: 1, kingWen: 6, symbol: '䷅', niPage: 3, huangPage: 'p.6'},
      {gua: 4, kingWen: 9, symbol: '䷈', niPage: 14, huangPage: 'p.9'},
      {gua: 8, kingWen: 14, symbol: '䷍', niPage: 25, huangPage: 'p.14'},
      {gua: 12, kingWen: 19, symbol: '䷒', niPage: 36, huangPage: 'p.19'},
      // ... add remaining from your table (e.g., gua 16:24 p.46, etc.)
      {gua: 64, kingWen: 2, symbol: '䷁', niPage: 209, huangPage: 'p.86'}
    ];

    // Mode toggle
    function toggleMode() {
      const mode = document.querySelector('input[name="divMode"]:checked').value;
      const stemSection = document.getElementById('stemSection');
      const directSection = document.getElementById('directSection');
      if (mode === 'stem') {
        stemSection.style.display = 'block';
        directSection.style.display = 'none';
      } else {
        stemSection.style.display = 'none';
        directSection.style.display = 'block';
      }
    }

    // Stem divination
    function divineTrigramStem() {
      const lowerNum = parseInt(document.getElementById('lowerTrigram').value);
      const stemNum = parseInt(document.getElementById('stem').value);
      const sum = lowerNum + stemNum;
      
      let upperNum = sum % 8;
      if (upperNum === 0) upperNum = 8;
      
      let movingLine = sum % 6;
      if (movingLine === 0) movingLine = 6;
      
      const lower = trigrams[lowerNum];
      const upper = trigrams[upperNum];
      
      const kingWen = ((upperNum - 1) * 8) + lowerNum;
      const hexSymbol = hexSymbols[kingWen] || '䷀';
      
      document.getElementById('divResult').innerHTML = `
        <h4>Divination Result</h4>
        <p><strong>Sum:</strong> ${sum}</p>
        <p><strong>Lower Trigram:</strong> ${lowerNum} ${lower.symbol} (${lower.name})</p>
        <p><strong>Upper Trigram:</strong> ${upperNum} ${upper.symbol} (${upper.name})</p>
        <p><strong>Hexagram:</strong> #${kingWen} ${hexSymbol}</p>
        <p><strong>Moving Line:</strong> ${movingLine} (bottom=1)</p>
        <div style="font-size: 24px; line-height: 1.2;">
          ${upper.symbol}<br>
          ${lower.symbol}
        </div>
        <button onclick="showRelevant(${kingWen})">Show Relations & References (Part B)</button>
        <button onclick="addToJournal(${kingWen}, ${movingLine})">Log to Journal</button>
      `;
      
      document.getElementById('lowerTrigram').value = '';
      document.getElementById('stem').value = '';
    }

    // Direct trigram selection
    function divineDirectTrigrams() {
      const lowerNum = parseInt(document.getElementById('directLower').value);
      const upperNum = parseInt(document.getElementById('directUpper').value);
      if (!lowerNum || !upperNum) return alert('Select both trigrams!');
      
      const lower = trigrams[lowerNum];
      const upper = trigrams[upperNum];
      
      const kingWen = ((upperNum - 1) * 8) + lowerNum;
      const hexSymbol = hexSymbols[kingWen] || '䷀';
      const movingLine = 0;  // Static; optional random
      
      document.getElementById('divResult').innerHTML = `
        <h4>Direct Selection Result</h4>
        <p><strong>Lower Trigram:</strong> ${lowerNum} ${lower.symbol} (${lower.name})</p>
        <p><strong>Upper Trigram:</strong> ${upperNum} ${upper.symbol} (${upper.name})</p>
        <p><strong>Hexagram:</strong> #${kingWen} ${hexSymbol}</p>
        <p><strong>Moving Line:</strong> None (static)</p>
        <div style="font-size: 24px; line-height: 1.2;">
          ${upper.symbol}<br>
          ${lower.symbol}
        </div>
        <button onclick="showRelevant(${kingWen})">Show Relations & References (Part B)</button>
        <button onclick="addToJournal(${kingWen}, ${movingLine})">Log to Journal</button>
      `;
      
      document.getElementById('directLower').value = '';
      document.getElementById('directUpper').value = '';
    }

    // Show relevant relations from tableData
    function showRelevant(kingWen) {
      // Simple relations calc (expand with mutual/inverse as needed)
      const opposite = 65 - kingWen;
      const inverse = 65 - kingWen;  // Placeholder; use bit reverse for accuracy
      const mutual = kingWen + 32 % 65 || 64;  // Placeholder
      const relations = [kingWen, opposite, inverse, mutual];
      
      const relevantRows = tableData.filter(row => relations.includes(row.kingWen));
      const tbody = document.getElementById('relationsBody');
      tbody.innerHTML = '';
      relevantRows.forEach(row => {
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${row.gua}</td>
          <td>${row.kingWen} ${row.symbol}</td>
          <td>Ni p.${row.niPage}</td>
          <td>Huang p.${row.huangPage}</td>
        `;
      });
    }

    // Journal tie-in
    function addToJournal(hex, moving) {
      document.getElementById('hex').value = `${hex} (Moving Line ${moving})`;
      document.getElementById('question').focus();
    }

    // Init mode
    toggleMode();
    </script>
</head>

<body>
    <h1>I Ching Hexagram Pages</h1>
    
    <!-- Part A: Divination -->
    <h3>Part A: Hexagram Generation</h3>
    <form onsubmit="return false;">
      <p>
        <label><input type="radio" name="divMode" value="stem" onclick="toggleMode()" checked> Stem Divination</label>
        <label><input type="radio" name="divMode" value="direct" onclick="toggleMode()"> Direct Trigrams</label>
      </p>
      
      <!-- Stem Mode -->
      <div id="stemSection">
        <p>
          <label>Lower Trigram (1-8): 
            <select id="lowerTrigram">
              <option value="">Select...</option>
              <option value="1">1: Qian ☰</option>
              <option value="2">2: Dui ☱</option>
              <option value="3">3: Li ☲</option>
              <option value="4">4: Zhen ☳</option>
              <option value="5">5: Xun ☴</option>
              <option value="6">6: Kan ☵</option>
              <option value="7">7: Gen ☶</option>
              <option value="8">8: Kun ☷</option>
            </select>
          </label>
        </p>
        <p>
          <label>Heavenly Stem (1-12): 
            <select id="stem">
              <option value="">Select...</option>
              <option value="1">1: Jia</option>
              <option value="2">2: Yi</option>
              <option value="3">3: Bing</option>
              <option value="4">4: Ding</option>
              <option value="5">5: Wu</option>
              <option value="6">6: Ji</option>
              <option value="7">7: Geng</option>
              <option value="8">8: Xin</option>
              <option value="9">9: Ren</option>
              <option value="10">10: Gui</option>
              <option value="11">11: Jia (cycle)</option>
              <option value="12">12: Yi (cycle)</option>
            </select>
          </label>
        </p>
        <button type="button" onclick="divineTrigramStem()">Divine</button>
      </div>
      
      <!-- Direct Mode -->
      <div id="directSection" style="display: none;">
        <p>
          <label>Lower Trigram (1-8): 
            <select id="directLower">
              <option value="">Select...</option>
              <option value="1">1: Qian ☰</option>
              <option value="2">2: Dui ☱</option>
              <option value="3">3: Li ☲</option>
              <option value="4">4: Zhen ☳</option>
              <option value="5">5: Xun ☴</option>
              <option value="6">6: Kan ☵</option>
              <option value="7">7: Gen ☶</option>
              <option value="8">8: Kun ☷</option>
            </select>
          </label>
        </p>
        <p>
          <label>Upper Trigram (1-8): 
            <select id="directUpper">
              <option value="">Select...</option>
              <option value="1">1: Qian ☰</option>
              <option value="2">2: Dui ☱</option>
              <option value="3">3: Li ☲</option>
              <option value="4">4: Zhen ☳</option>
              <option value="5">5: Xun ☴</option>
              <option value="6">6: Kan ☵</option>
              <option value="7">7: Gen ☶</option>
              <option value="8">8: Kun ☷</option>
            </select>
          </label>
        </p>
        <button type="button" onclick="divineDirectTrigrams()">Select</button>
      </div>
    </form>
    <div id="divResult"></div>

    <!-- Part B: Relations Table (Dynamic) -->
    <h3>Part B: Relevant Gua Relations</h3>
    <div class="table-container">
      <table id="relationsTable" border="1">
        <thead><tr><th>Gua #</th><th>King Wen & Symbol</th><th>Ni Page</th><th>Huang Page</th></tr></thead>
        <tbody id="relationsBody"></tbody>
      </table>
    </div>

    <!-- Journal -->
    <h2>My Divination Journal</h2>
    <form onsubmit="addEntry(); return false;">
      <p><label>Question: <input type="text" id="question" placeholder="e.g., Career next steps?" required></label></p>
      <p><label>Hexagram: <input type="text" id="hex" placeholder="e.g., 23: Po ䷖" required></label></p>
      <p><label>Results/Notes: <textarea id="notes" placeholder="e.g., Splitting Apart; changing line 2; release old patterns"></textarea></label></p>
      <button type="submit">Log Entry</button>
    </form>
    <button onclick="exportJournal()">Export to CSV</button>

    <table id="journalTable" border="1">
      <thead><tr><th>Date</th><th>Question</th><th>Hex</th><th>Notes</th><th>Actions</th></tr></thead>
      <tbody id="journalBody"></tbody>
    </table>
    <p><em>Entries saved locally—clear browser data to reset. Search table with Ctrl+F.</em></p>

    <!-- Gua Mapping Example (Ni) -->
    <h3><img src="images/ni-cover.jpg" alt="Master Ni Cover" width="60" style="vertical-align:middle;"> Gua Checkpoints: Master Ni</h3>
    <div class="table-container">
      <table border="1">
        <tr><th>Gua #</th><th>King Wen #</th><th>Symbol</th><th>Ni Pages (Slim)</th></tr>
        <tr><td>1</td><td>6</td><td>䷅</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=3')">p.3</a></td></tr>
        <tr><td>8</td><td>14</td><td>䷍</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=25')">p.25</a></td></tr>
        <tr><td>16</td><td>24</td><td>䷗</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=46')">p.46</a></td></tr>
        <tr><td>24</td><td>34</td><td>䷪</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=66')">p.66</a></td></tr>
        <tr><td>32</td><td>45</td><td>䷬</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=91')">p.91</a></td></tr>
        <tr><td>40</td><td>57</td><td>䷸</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=116')">p.116</a></td></tr>
        <tr><td>48</td><td>65</td><td>䷀</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=145')">p.145</a></td></tr>
        <tr><td>56</td><td>76</td><td>䷼</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=172')">p.172</a></td></tr>
        <tr><td>64</td><td>2</td><td>䷁</td><td><a href="#" onclick="openPDF('proton-ni-slim#page=209')">p.209</a></td></tr>
      </table>
    </div>

    <!-- Main Hex Table (Placeholder - expand to 64 rows with your data) -->
    <h2>Main Hexagram References</h2>
    <div class="table-container">
      <table border="1">
        <tr><th>#</th><th>Name</th><th>Book A (e.g., Ni)</th><th>Book B (e.g., Huang)</th></tr>
        <tr><td>1</td><td>Ch'ien / The Creative ䷀</td><td>Initiating p.3 <a href="#" onclick="openPDF('proton-ni-slim#page=3')">Slim</a></td><td>The Creative p.6 <a href="#" onclick="openPDF('proton-huang-slim#page=6')">Slim</a></td></tr>
        <!-- Add 63 more rows from your spreadsheet; e.g. -->
        <tr><td>2</td><td>K'un / The Receptive ䷁</td><td>Field p.209 <a href="#" onclick="openPDF('proton-ni-slim#page=209')">Slim</a></td><td>The Receptive p.86 <a href="#" onclick="openPDF('proton-huang-slim#page=86')">Slim</a></td></tr>
        <!-- ... -->
      </table>
    </div>
</body>
</html>
