<script type="module">
    // Import shared data and IChingTable
    import { hexagrams, names, book1, book2, book3, book4, book5, book6, book7, book8, book9, book10, book11, book12, IChingTable } from './data.js';

    let selectedTrigram = null;
    let selectedStem = null;
    let currentSequence = 'fuxi'; // 'fuxi' or 'kingwen'

    // Trigram data
    const trigrams = {
        1: { symbol: '‚ò∞', english: 'Heaven', chinese: 'Qian' },
        2: { symbol: '‚ò±', english: 'Lake', chinese: 'Dui' },
        3: { symbol: '‚ò≤', english: 'Fire', chinese: 'Li' },
        4: { symbol: '‚ò≥', english: 'Thunder', chinese: 'Zhen' },
        5: { symbol: '‚ò¥', english: 'Wind', chinese: 'Xun' },
        6: { symbol: '‚òµ', english: 'Water', chinese: 'Kan' },
        7: { symbol: '‚ò∂', english: 'Mountain', chinese: 'Gen' },
        8: { symbol: '‚ò∑', english: 'Earth', chinese: 'Kun' }
    };

    // Fu Xi sequence (Earlier Heaven)
    const fuxiSequence = [1, 5, 2, 6, 3, 7, 4, 8];

    // King Wen sequence (Later Heaven)
    const kingwenSequence = [6, 8, 4, 5, 1, 2, 7, 3];

    // Stem times for display
    const stemTimes = {
        1: '11pm-1am', 2: '1am-3am', 3: '3am-5am', 4: '5am-7am', 
        5: '7am-9am', 6: '9am-11am', 7: '11am-1pm', 8: '1pm-3pm',
        9: '3pm-5pm', 10: '5pm-7pm', 11: '7pm-9pm', 12: '9pm-11pm'
    };

    // Initialize IChingTable
    const iChingTable = new IChingTable();
    console.log('IChingTable initialized:', iChingTable);

    // Render trigrams based on current sequence
    function renderTrigrams() {
        const sequence = currentSequence === 'fuxi' ? fuxiSequence : kingwenSequence;
        const grid = document.getElementById('trigramGrid');
        grid.innerHTML = '';

        sequence.forEach((trigramValue, index) => {
            const displayNumber = index + 1;
            const trigram = trigrams[trigramValue];
            const isSelected = selectedTrigram === trigramValue ? 'selected' : '';
            
            const btn = document.createElement('div');
            btn.className = `selection-btn ${isSelected}`;
            btn.setAttribute('data-value', trigramValue);
            btn.setAttribute('data-type', 'trigram');
            btn.onclick = function() { selectTrigram(this); };
            btn.innerHTML = `
                <div class="trigram-number">${displayNumber}</div>
                <div class="trigram-symbol">${trigram.symbol}</div>
                <div class="trigram-english">${trigram.english}</div>
                <div class="trigram-chinese">${trigram.chinese}</div>
            `;
            grid.appendChild(btn);
        });
    }

    // Toggle sequence
    window.toggleSequence = function() {
        currentSequence = currentSequence === 'fuxi' ? 'kingwen' : 'fuxi';
        document.getElementById('sequenceLabel').textContent = 
            currentSequence === 'fuxi' ? 'Fu Xi Sequence' : 'King Wen Sequence';
        renderTrigrams();
    }

    // Select trigram
    window.selectTrigram = function(btn) {
        const value = parseInt(btn.getAttribute('data-value'));
        if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            selectedTrigram = null;
        } else {
            document.querySelectorAll('.selection-btn[data-type="trigram"]').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTrigram = value;
        }
        checkSelection();
    }

    // Select stem
    window.selectStem = function(btn) {
        const value = parseInt(btn.getAttribute('data-value'));
        if (btn.classList.contains('selected')) {
            btn.classList.remove('selected');
            selectedStem = null;
        } else {
            document.querySelectorAll('.selection-btn[data-type="stem"]').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedStem = value;
        }
        checkSelection();
    }

    // Check selection status
    function checkSelection() {
        const divineBtn = document.getElementById('divineBtn');
        divineBtn.disabled = !(selectedTrigram && selectedStem);
        console.log('Selection checked:', { selectedTrigram, selectedStem, divineBtnDisabled: divineBtn.disabled });
    }

    // Divine hexagram
    window.divineTrigramStem = function() {
        console.log('Divining with:', { selectedTrigram, selectedStem });
        if (!selectedTrigram || !selectedStem) {
            alert('Please select both a trigram and a stem!');
            return;
        }

        const lowerTrigram = selectedTrigram;
        const sum = lowerTrigram + selectedStem;
        let upperTrigram = sum % 8;
        if (upperTrigram === 0) upperTrigram = 8;
        let movingLine = sum % 6 || 6;
        
        try {
            const kingWen = iChingTable.getHexagram(lowerTrigram, upperTrigram);
            console.log('Calculated kingWen:', kingWen);
            const hexSymbol = hexagrams[kingWen - 1];
            const hexName = names[kingWen - 1];

            const lowerName = trigrams[lowerTrigram].chinese;
            const upperName = trigrams[upperTrigram].chinese;
            const stemTime = stemTimes[selectedStem];

            document.getElementById('divResult').innerHTML = `
                <div class="result-box">
                    <h3>‚ú® Divination Result</h3>
                    <div class="calculation-box">
                        ${lowerName} ${lowerTrigram} + ${stemTime} ${selectedStem} ‚Üí ${lowerTrigram} + ${selectedStem} = ${sum}
                    </div>
                    <p><strong>Lower Trigram (Bottom):</strong> ${lowerName} (${lowerTrigram})</p>
                    <p><strong>Upper Trigram (Top):</strong> ${upperName} (${upperTrigram})</p>
                    <p><strong>Sum:</strong> ${sum} (${sum} mod 8 = ${upperTrigram})</p>
                    <p><strong>Hexagram:</strong> #${kingWen} ${hexSymbol} - ${hexName}</p>
                    <p><strong>Moving Line:</strong> ${movingLine} (${sum} mod 6 = ${movingLine})</p>
                    <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap;">
                        <button onclick="showRelevant(${kingWen})" class="btn-info">üìñ Show Related Hexagrams</button>
                        <button onclick="prefillJournal(${kingWen}, ${movingLine})" class="btn-success">üìù Add to Journal</button>
                    </div>
                </div>
            `;
            console.log('Divination result displayed');
            showRelevant(kingWen);
        } catch (error) {
            console.error('Error in divination:', error);
            alert('An error occurred during divination. Check the console for details.');
        }
    }

    // Show relevant hexagrams
    window.showRelevant = function(kingWen) {
        const inverse = 65 - kingWen;
        const related = [kingWen];
        if (inverse > 0 && inverse <= 64 && inverse !== kingWen) related.push(inverse);

        const tbody = document.getElementById('relevantTableBody');
        tbody.innerHTML = '';
        related.forEach(n => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${n}</td>
                <td>${hexagrams[n - 1]}</td>
                <td>${names[n - 1]}</td>
                <td>${book1[n - 1] || '-'}</td>
                <td>${book2[n - 1] || '-'}</td>
                <td>${book3[n - 1] || '-'}</td>
                <td>${book4[n - 1] || '-'}</td>
                <td>${book5[n - 1] || '-'}</td>
                <td>${book6[n - 1] || '-'}</td>
                <td>${book7[n - 1] || '-'}</td>
                <td>${book8[n - 1] || '-'}</td>
                <td>${book9[n - 1] || '-'}</td>
                <td>${book10[n - 1] || '-'}</td>
                <td>${book11[n - 1] || '-'}</td>
                <td>${book12[n - 1] || '-'}</td>
            `;
        });
        
        document.getElementById('relevantSection').style.display = 'block';
    }

    // Prefill journal
    window.prefillJournal = function(kingWen, movingLine) {
        const hex = `${kingWen}: ${names[kingWen - 1]} ${hexagrams[kingWen - 1]} (Line ${movingLine})`;
        document.getElementById('hex').value = hex;
        document.getElementById('question').focus();
        window.scrollTo({ top: document.getElementById('question').offsetTop - 100, behavior: 'smooth' });
    }

    // Journal functions
    let journal = JSON.parse(localStorage.getItem('ichingJournal')) || [];

    window.addEntry = function() {
        const question = document.getElementById('question').value;
        const hex = document.getElementById('hex').value;
        const notes = document.getElementById('notes').value;
        if (!question || !hex) return alert('Please add question and hexagram!');
        
        const entry = { id: Date.now(), date: new Date().toISOString().split('T')[0], question, hex, notes };
        journal.unshift(entry);
        localStorage.setItem('ichingJournal', JSON.stringify(journal));
        displayJournal();
        clearForm();
    }

    function displayJournal() {
        const tbody = document.getElementById('journalBody');
        tbody.innerHTML = '';
        if (journal.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">No entries yet. Start by logging your first divination above.</td></tr>';
            return;
        }
        journal.forEach(entry => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${entry.date}</td>
                <td>${entry.question}</td>
                <td>${entry.hex}</td>
                <td>${entry.notes || '-'}</td>
                <td style="text-align:center;"><button onclick="deleteEntry(${entry.id})" class="btn-danger">Delete</button></td>
            `;
        });
    }

    window.deleteEntry = function(id) {
        if (!confirm('Delete this journal entry?')) return;
        journal = journal.filter(e => e.id !== id);
        localStorage.setItem('ichingJournal', JSON.stringify(journal));
        displayJournal();
    }

    function clearForm() {
        document.getElementById('question').value = '';
        document.getElementById('hex').value = '';
        document.getElementById('notes').value = '';
    }

    window.exportJournal = function() {
        if (journal.length === 0) {
            alert('No entries to export!');
            return;
        }
        const csv = ['Date,Question,Hexagram,Notes'].concat(journal.map(e => `${e.date},"${e.question}","${e.hex}","${e.notes || ''}"`)).join('\n');
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'iching-journal.csv';
        a.click();
        URL.revokeObjectURL(url);
    }

    // Initialize
    renderTrigrams();
    displayJournal();
</script>
