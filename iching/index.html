<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching Divination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .book-cover {
            width: 100px;
            height: auto;
            object-fit: cover;
            margin: 0 auto 8px;
        }
        
        .i-ching-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .i-ching-table thead {
            background: #d1d5db;
        }
        
        .i-ching-table th {
            padding: 1rem;
            font-weight: bold;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        .i-ching-table th:first-child { text-align: left; white-space: normal; width: 70px; }
        .i-ching-table th:nth-child(2) { text-align: center; white-space: nowrap; }
        .i-ching-table th:nth-child(3) { text-align: left; white-space: nowrap; }
        .i-ching-table th:nth-child(n+4) { text-align: center; width: 128px; font-size: 0.75rem; }
        
        .i-ching-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .i-ching-table td:first-child { padding: 0.75rem 0.5rem; white-space: nowrap; text-align: center; }
        .i-ching-table td:nth-child(2) { padding: 0.75rem 0.5rem; font-size: 3rem; white-space: nowrap; text-align: center; }
        .i-ching-table td:nth-child(3) { padding: 0.75rem 0.75rem; white-space: nowrap; }
        
        .i-ching-table tbody tr:nth-child(even) { background: #f3f4f6; }
        .i-ching-table tbody tr:hover { background: #f9fafb; }
        
        .table-container { max-width: 100%; overflow-x: auto; }
        #divResult, #journalResult { border: 1px solid #ccc; padding: 10px; margin: 10px 0; background: #f9f9f9; }
        
        .selection-grid {
            display: grid;
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .trigram-grid {
            grid-template-columns: repeat(2, minmax(50%, 1fr));
        }
        
        .stem-grid {
            grid-template-columns: repeat(6, minmax(150px, 1fr));
        }
        
        .selection-btn {
            padding: 10px;
            border: 2px solid #ccc;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
            background: #fff;
            transition: all 0.3s;
        }
        
        .selection-btn.selected {
            border-color: #007BFF;
            background: #e6f0fa;
            font-weight: bold;
        }
        
        .selection-btn:hover {
            background: #f0f0f0;
        }
        
        #divineBtn {
            display: none;
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        #divineBtn:enabled {
            display: inline-block;
        }
        
        #divineBtn:hover {
            background: #218838;
        }
        
        #relevantSection {
            display: none;
        }
        
        #relevantSection.show {
            display: block;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-6">
    <div class="max-w-full mx-auto">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-800 mb-4">I Ching Divination</h1>
            <p class="text-lg text-gray-600">Consult the Oracle and Record Your Insights</p>
            <a href="reference.html" class="mt-4 inline-block px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Reference Table</a>
        </div>

        <!-- Divination Section -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Divination</h2>
        <div>
            <div class="mb-4">
                <h3 class="text-xl font-medium">Select Lower Trigram</h3>
                <div class="selection-grid trigram-grid">
                    <div class="selection-btn" data-value="1" data-type="trigram" onclick="selectTrigram(this)">☰ Qian</div>
                    <div class="selection-btn" data-value="2" data-type="trigram" onclick="selectTrigram(this)">☱ Dui</div>
                    <div class="selection-btn" data-value="3" data-type="trigram" onclick="selectTrigram(this)">☲ Li</div>
                    <div class="selection-btn" data-value="4" data-type="trigram" onclick="selectTrigram(this)">☳ Zhen</div>
                    <div class="selection-btn" data-value="5" data-type="trigram" onclick="selectTrigram(this)">☴ Xun</div>
                    <div class="selection-btn" data-value="6" data-type="trigram" onclick="selectTrigram(this)">☵ Kan</div>
                    <div class="selection-btn" data-value="7" data-type="trigram" onclick="selectTrigram(this)">☶ Gen</div>
                    <div class="selection-btn" data-value="8" data-type="trigram" onclick="selectTrigram(this)">☷ Kun</div>
                </div>
            </div>
            <div class="mb-4">
                <h3 class="text-xl font-medium">Select Heavenly Stem (Time)</h3>
                <div class="selection-grid stem-grid">
                    <div class="selection-btn" data-value="7" data-type="stem" onclick="selectStem(this)">Geng (11pm-1am)</div>
                    <div class="selection-btn" data-value="8" data-type="stem" onclick="selectStem(this)">Xin (1am-3am)</div>
                    <div class="selection-btn" data-value="9" data-type="stem" onclick="selectStem(this)">Ren (3am-5am)</div>
                    <div class="selection-btn" data-value="10" data-type="stem" onclick="selectStem(this)">Gui (5am-7am)</div>
                    <div class="selection-btn" data-value="11" data-type="stem" onclick="selectStem(this)">Jia (7am-9am)</div>
                    <div class="selection-btn" data-value="12" data-type="stem" onclick="selectStem(this)">Yi (9am-11am)</div>
                </div>
                <div class="selection-grid stem-grid" style="margin-top: 10px;">
                    <div class="selection-btn" data-value="1" data-type="stem" onclick="selectStem(this)">Bing (11am-1pm)</div>
                    <div class="selection-btn" data-value="2" data-type="stem" onclick="selectStem(this)">Ding (1pm-3pm)</div>
                    <div class="selection-btn" data-value="3" data-type="stem" onclick="selectStem(this)">Wu (3pm-5pm)</div>
                    <div class="selection-btn" data-value="4" data-type="stem" onclick="selectStem(this)">Ji (5pm-7pm)</div>
                    <div class="selection-btn" data-value="5" data-type="stem" onclick="selectStem(this)">Geng (7pm-9pm)</div>
                    <div class="selection-btn" data-value="6" data-type="stem" onclick="selectStem(this)">Xin (9pm-11pm)</div>
                </div>
            </div>
            <button id="divineBtn" onclick="divineTrigramStem()" disabled>Divine</button>
        </div>
        <div id="divResult"></div>

        <!-- Relevant Rows Table -->
        <div id="relevantSection">
            <h2 class="text-2xl font-semibold text-gray-800 mb-4">Relevant Hexagrams</h2>
            <div class="bg-white rounded-xl shadow-lg overflow-hidden">
                <div class="overflow-x-auto table-container">
                    <table class="i-ching-table">
                        <thead>
                            <tr>
                                <th>Gua<br>number</th>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th><img src="covers/iching.png" alt="The Book of Changes" class="book-cover">The Book of Changes</th>
                                <th><img src="covers/guide-iching.png" alt="A Guide to the I Ching" class="book-cover">A Guide to the I Ching</th>
                                <th><img src="covers/complete-iching.png" alt="The Complete I Ching.10th Ed" class="book-cover">The Complete I Ching.10th Ed</th>
                                <th><img src="covers/authentic-iching.png" alt="The Authentic I Ching" class="book-cover">The Authentic I Ching</th>
                                <th><img src="covers/iching-pt1.png" alt="I Ching Wilhelm Pt.1" class="book-cover">I Ching Pt.1</th>
                                <th><img src="covers/iching-pt2.png" alt="I Ching Wilhelm Pt.2" class="book-cover">I Ching Pt.2</th>
                                <th><img src="covers/taoist-iching.png" alt="Taoist I Ching" class="book-cover">Taoist I Ching</th>
                                <th><img src="covers/tao-organisation.png" alt="Tao of Organisation" class="book-cover">Tao of Organisation</th>
                                <th><img src="covers/astrology-iching.png" alt="Astrology of I Ching" class="book-cover">Astrology of I Ching</th>
                                <th><img src="covers/book10.png" alt="Book 10" class="book-cover">Book 10</th>
                                <th><img src="covers/book11.png" alt="Book 11" class="book-cover">Book 11</th>
                                <th><img src="covers/book12.png" alt="Book 12" class="book-cover">Book 12</th>
                            </tr>
                        </thead>
                        <tbody id="relevantTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Journal Section -->
        <h2 class="text-2xl font-semibold text-gray-800 mb-4">Journal</h2>
        <form onsubmit="addEntry(); return false;" class="mb-6">
            <div class="mb-4">
                <label class="block mb-2">Question: 
                    <input type="text" id="question" class="w-full p-2 border rounded" placeholder="e.g., Career next steps?" required>
                </label>
            </div>
            <div class="mb-4">
                <label class="block mb-2">Hexagram: 
                    <input type="text" id="hex" class="w-full p-2 border rounded" placeholder="e.g., 1: The Creative ䷀" required>
                </label>
            </div>
            <div class="mb-4">
                <label class="block mb-2">Results/Notes: 
                    <textarea id="notes" class="w-full p-2 border rounded" placeholder="e.g., The Creative; changing line 2"></textarea>
                </label>
            </div>
            <button type="submit" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Log Entry</button>
            <button type="button" onclick="exportJournal()" class="ml-2 px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600">Export to CSV</button>
        </form>
        <div id="journalResult"></div>
        <table class="i-ching-table mt-4">
            <thead>
                <tr>
                    <th>Date</th>
                    <th>Question</th>
                    <th>Hex</th>
                    <th>Notes</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="journalBody"></tbody>
        </table>
    </div>

    <script type="module">
        // Import shared data
        import { hexagrams, names, book1, book2, book3, book4, book5, book6, book7, book8, book9, book10, book11, book12 } from './data.js';

        let selectedTrigram = null;
        let selectedStem = null;

        // Journal data and functions
        let journal = JSON.parse(localStorage.getItem('ichingJournal')) || [];

        function addEntry() {
            const question = document.getElementById('question').value;
            const hex = document.getElementById('hex').value;
            const notes = document.getElementById('notes').value;
            if (!question || !hex) return alert('Please add question and hexagram!');
            
            const entry = { id: Date.now(), date: new Date().toISOString().split('T')[0], question, hex, notes };
            journal.unshift(entry);
            localStorage.setItem('ichingJournal', JSON.stringify(journal));
            displayJournal();
            clearForm();
        }

        function displayJournal() {
            const tbody = document.getElementById('journalBody');
            tbody.innerHTML = '';
            journal.forEach(entry => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.question}</td>
                    <td>${entry.hex}</td>
                    <td>${entry.notes}</td>
                    <td><button onclick="deleteEntry(${entry.id})" class="px-2 py-1 bg-red-500 text-white rounded hover:bg-red-600">Delete</button></td>
                `;
            });
        }

        function deleteEntry(id) {
            journal = journal.filter(e => e.id !== id);
            localStorage.setItem('ichingJournal', JSON.stringify(journal));
            displayJournal();
        }

        function clearForm() {
            document.getElementById('question').value = '';
            document.getElementById('hex').value = '';
            document.getElementById('notes').value = '';
        }

        function exportJournal() {
            const csv = ['Date,Question,Hex,Notes'].concat(journal.map(e => `${e.date},"${e.question}",${e.hex},"${e.notes}"`)).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'iching-journal.csv'; a.click();
        }

        // Divination functions
        function selectTrigram(btn) {
            document.querySelectorAll('.selection-btn[data-type="trigram"]').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedTrigram = parseInt(btn.getAttribute('data-value'));
            checkSelection();
        }

        function selectStem(btn) {
            document.querySelectorAll('.selection-btn[data-type="stem"]').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
            selectedStem = parseInt(btn.getAttribute('data-value'));
            checkSelection();
        }

        function checkSelection() {
            const divineBtn = document.getElementById('divineBtn');
            if (selectedTrigram && selectedStem) {
                divineBtn.disabled = false;
            } else {
                divineBtn.disabled = true;
            }
        }

        function divineTrigramStem() {
            if (!selectedTrigram || !selectedStem) return alert('Please select both a trigram and a stem!');

            const sum = selectedTrigram + selectedStem;
            let upperNum = sum % 8;
            if (upperNum === 0) upperNum = 8;
            let movingLine = sum % 6 || 6;
            const kingWen = ((upperNum - 1) * 8) + selectedTrigram;
            const hexSymbol = hexagrams[kingWen - 1];
            const hexName = names[kingWen - 1];

            document.getElementById('divResult').innerHTML = `
                <h3>Divination Result</h3>
                <p><strong>Sum:</strong> ${sum}</p>
                <p><strong>Lower Trigram:</strong> ${selectedTrigram}</p>
                <p><strong>Upper Trigram:</strong> ${upperNum}</p>
                <p><strong>Hexagram:</strong> #${kingWen} ${hexSymbol} (${hexName})</p>
                <p><strong>Moving Line:</strong> ${movingLine}</p>
                <button onclick="showRelevant(${kingWen})" class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600">Show Relevant Hexagrams</button>
                <button onclick="prefillJournal(${kingWen}, ${movingLine})" class="ml-2 px-4 py-2 bg-green-500 text-white rounded hover:bg-green-600">Log to Journal</button>
            `;

            document.getElementById('relevantSection').classList.add('show');

            selectedTrigram = null;
            selectedStem = null;
            document.getElementById('divineBtn').disabled = true;
            document.querySelectorAll('.selection-btn').forEach(b => b.classList.remove('selected'));
        }

        function showRelevant(kingWen) {
            const inverse = 65 - kingWen; // Placeholder; refine with line flip
            const reverse = 65 - kingWen; // Placeholder; refine with line order reversal
            const mutual = (kingWen + 32) % 64 || 64; // Placeholder; adjust per I Ching mutuals
            const relevant = [kingWen, inverse, reverse, mutual].filter(n => n > 0 && n <= 64);

            const tbody = document.getElementById('relevantTableBody');
            tbody.innerHTML = '';
            relevant.forEach(n => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${n}</td>
                    <td>${hexagrams[n - 1]}</td>
                    <td>${names[n - 1]}</td>
                    <td>${book1[n - 1] || 'N/A'}</td>
                    <td>${book2[n - 1] || 'N/A'}</td>
                    <td>${book3[n - 1] || 'N/A'}</td>
                    <td>${book4[n - 1] || 'N/A'}</td>
                    <td>${book5[n - 1] || 'N/A'}</td>
                    <td>${book6[n - 1] || 'N/A'}</td>
                    <td>${book7[n - 1] || 'N/A'}</td>
                    <td>${book8[n - 1] || 'N/A'}</td>
                    <td>${book9[n - 1] || 'N/A'}</td>
                    <td>${book10[n - 1] || 'N/A'}</td>
                    <td>${book11[n - 1] || 'N/A'}</td>
                    <td>${book12[n - 1] || 'N/A'}</td>
                `;
            });
        }

        function prefillJournal(kingWen, movingLine) {
            const hex = `${kingWen}: ${names[kingWen - 1]} (${hexagrams[kingWen - 1]}) (Moving Line ${movingLine})`;
            document.getElementById('hex').value = hex;
            document.getElementById('question').focus();
        }

        // Initialize
        displayJournal();
    </script>
</body>
</html>
