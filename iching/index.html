<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching Divination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* ... (keep all your existing CSS styles) ... */
        
        .compact-result {
            background: #fff;
            border: 2px solid #86efac;
            border-radius: 8px;
            padding: 20px;
            margin: 16px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #166534;
        }
        
        .compact-line {
            margin: 8px 0;
            padding: 8px 12px;
            background: #f0fdf4;
            border-radius: 6px;
            border-left: 4px solid #22c55e;
        }
        
        .trigram-compact {
            display: inline-block;
            text-align: center;
            margin: 0 10px;
            padding: 10px;
        }
        
        .trigram-compact-symbol {
            font-size: 3rem;
            line-height: 1;
        }
        
        .trigram-compact-name {
            font-size: 0.9rem;
            color: #6b7280;
            margin-top: 4px;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">☯ I Ching Divination</h1>
            <p class="text-xl text-gray-600 mb-6">Consult the Oracle and Record Your Insights</p>
            <a href="reference.html" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition shadow-md hover:shadow-lg">
                📖 View Reference Table
            </a>
        </div>

        <!-- Divination Section -->
        <div class="section-card">
            <h2 class="section-title">🎲 Divination</h2>
            
            <div class="mb-8">
                <div class="subsection-title">
                    <span>Select Lower Trigram (Bottom)</span>
                    <button class="btn-toggle" onclick="toggleSequence()">
                        <span id="sequenceLabel">Fu Xi Sequence</span> 
                    </button>
                </div>
                <div id="trigramGrid" class="grid grid-cols-4 gap-4">
                    <!-- Trigrams will be populated by JavaScript -->
                </div>
            </div>
            
            <div class="mb-8">
                <h3 class="subsection-title">Select Heavenly Stem (Time of Day)</h3>
                <div class="grid grid-cols-3 sm:grid-cols-4 md:grid-cols-6 gap-3">
                    <div class="selection-btn" data-value="1" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">1</div>
                        <div class="stem-time">11pm-1am</div>
                        <div class="stem-chinese">Geng</div>
                    </div>
                    <div class="selection-btn" data-value="2" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">2</div>
                        <div class="stem-time">1am-3am</div>
                        <div class="stem-chinese">Xin</div>
                    </div>
                    <div class="selection-btn" data-value="3" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">3</div>
                        <div class="stem-time">3am-5am</div>
                        <div class="stem-chinese">Ren</div>
                    </div>
                    <div class="selection-btn" data-value="4" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">4</div>
                        <div class="stem-time">5am-7am</div>
                        <div class="stem-chinese">Gui</div>
                    </div>
                    <div class="selection-btn" data-value="5" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">5</div>
                        <div class="stem-time">7am-9am</div>
                        <div class="stem-chinese">Jia</div>
                    </div>
                    <div class="selection-btn" data-value="6" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">6</div>
                        <div class="stem-time">9am-11am</div>
                        <div class="stem-chinese">Yi</div>
                    </div>
                    <div class="selection-btn" data-value="7" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">7</div>
                        <div class="stem-time">11am-1pm</div>
                        <div class="stem-chinese">Bing</div>
                    </div>
                    <div class="selection-btn" data-value="8" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">8</div>
                        <div class="stem-time">1pm-3pm</div>
                        <div class="stem-chinese">Ding</div>
                    </div>
                    <div class="selection-btn" data-value="9" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">9</div>
                        <div class="stem-time">3pm-5pm</div>
                        <div class="stem-chinese">Wu</div>
                    </div>
                    <div class="selection-btn" data-value="10" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">10</div>
                        <div class="stem-time">5pm-7pm</div>
                        <div class="stem-chinese">Ji</div>
                    </div>
                    <div class="selection-btn" data-value="11" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">11</div>
                        <div class="stem-time">7pm-9pm</div>
                        <div class="stem-chinese">Geng</div>
                    </div>
                    <div class="selection-btn" data-value="12" data-type="stem" onclick="selectStem(this)">
                        <div class="stem-number">12</div>
                        <div class="stem-time">9pm-11pm</div>
                        <div class="stem-chinese">Xin</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button id="divineBtn" class="btn-primary" onclick="divineTrigramStem()" disabled>✨ Divine Hexagram</button>
            </div>
            
            <div id="divResult"></div>
        </div>

        <!-- ... (rest of your HTML remains the same) ... -->
    </div>

    <script type="module">
        // Import shared data
        import { hexagrams, names, book1, book2, book3, book4, book5, book6, book7, book8, book9 } from './data.js';

        // I Ching Table class for hexagram lookup
        class IChingTable {
            constructor() {
                this.table = [
                    [1, 43, 14, 34, 9, 5, 26, 11],    // lower trigram 1
                    [10, 58, 38, 54, 61, 60, 41, 19], // lower trigram 2
                    [13, 49, 30, 55, 37, 63, 22, 36], // lower trigram 3
                    [25, 17, 21, 51, 42, 3, 27, 24],  // lower trigram 4
                    [44, 28, 50, 32, 57, 48, 18, 46], // lower trigram 5
                    [6, 47, 64, 40, 59, 29, 4, 7],    // lower trigram 6
                    [33, 31, 56, 62, 53, 39, 52, 15], // lower trigram 7
                    [12, 45, 35, 16, 20, 8, 23, 2]    // lower trigram 8
                ];
            }

            getHexagram(lowerTrigram, upperTrigram) {
                return this.table[lowerTrigram - 1][upperTrigram - 1];
            }
        }

        let selectedTrigram = null;
        let selectedStem = null;
        let currentSequence = 'fuxi'; // 'fuxi' or 'kingwen'

        // Trigram data with binary representations
        const trigrams = {
            1: { symbol: '☰', english: 'Heaven', chinese: 'Qian', binary: '111' },
            2: { symbol: '☱', english: 'Lake', chinese: 'Dui', binary: '011' },
            3: { symbol: '☲', english: 'Fire', chinese: 'Li', binary: '101' },
            4: { symbol: '☳', english: 'Thunder', chinese: 'Zhen', binary: '001' },
            5: { symbol: '☴', english: 'Wind', chinese: 'Xun', binary: '110' },
            6: { symbol: '☵', english: 'Water', chinese: 'Kan', binary: '010' },
            7: { symbol: '☶', english: 'Mountain', chinese: 'Gen', binary: '100' },
            8: { symbol: '☷', english: 'Earth', chinese: 'Kun', binary: '000' }
        };

        // ... (keep all your helper functions: getTrigramFromBinary, getTransformedHexagram, etc.)

        // Fu Xi sequence (Earlier Heaven)
        const fuxiSequence = [1, 5, 2, 6, 3, 7, 4, 8];

        // King Wen sequence (Later Heaven)
        const kingwenSequence = [6, 8, 4, 5, 1, 2, 7, 3];

        // Stem times for display
        const stemTimes = {
            1: '11pm-1am', 2: '1am-3am', 3: '3am-5am', 4: '5am-7am', 
            5: '7am-9am', 6: '9am-11am', 7: '11am-1pm', 8: '1pm-3pm',
            9: '3pm-5pm', 10: '5pm-7pm', 11: '7pm-9pm', 12: '9pm-11pm'
        };

        // Initialize IChingTable
        const iChingTable = new IChingTable();

        // Render trigrams based on current sequence - NOW 4x2 GRID
        function renderTrigrams() {
            const sequence = currentSequence === 'fuxi' ? fuxiSequence : kingwenSequence;
            const grid = document.getElementById('trigramGrid');
            grid.innerHTML = '';

            sequence.forEach((trigramValue, index) => {
                const trigram = trigrams[trigramValue];
                const isSelected = selectedTrigram === trigramValue ? 'selected' : '';
                
                const btn = document.createElement('div');
                btn.className = `selection-btn ${isSelected}`;
                btn.setAttribute('data-value', trigramValue);
                btn.setAttribute('data-type', 'trigram');
                btn.onclick = function() { selectTrigram(this); };
                btn.innerHTML = `
                    <div class="trigram-number">${index + 1}</div>
                    <div class="trigram-symbol">${trigram.symbol}</div>
                    <div class="trigram-english">${trigram.english}</div>
                    <div class="trigram-chinese">${trigram.chinese}</div>
                `;
                grid.appendChild(btn);
            });
        }

        // ... (keep all your existing functions: toggleSequence, journal functions, etc.)

        // UPDATED divineTrigramStem function with compact output
        window.divineTrigramStem = function() {
            if (!selectedTrigram || !selectedStem) return alert('Please select both a trigram and a stem!');

            const lowerTrigram = selectedTrigram;
            const sum = lowerTrigram + selectedStem;
            let upperTrigram = sum % 8;
            if (upperTrigram === 0) upperTrigram = 8;
            let movingLine = sum % 6 || 6;
            
            // Use IChingTable to get the hexagram number
            const kingWen = iChingTable.getHexagram(lowerTrigram, upperTrigram);
            const hexSymbol = hexagrams[kingWen - 1];
            const hexName = names[kingWen - 1];

            // Calculate transformed hexagram
            const transformedNum = getTransformedHexagram(lowerTrigram, upperTrigram, movingLine);
            const transformedSymbol = hexagrams[transformedNum - 1];
            const transformedName = names[transformedNum - 1];

            // Get names for display
            const lowerName = trigrams[lowerTrigram].chinese;
            const upperName = trigrams[upperTrigram].chinese;
            const stemTime = stemTimes[selectedStem];

            document.getElementById('divResult').innerHTML = `
                <div class="result-box">
                    <h3>✨ Divination Result</h3>
                    
                    <div class="compact-result">
                        <div class="compact-line">
                            <strong>Calculation:</strong> Lower Trigram ${lowerTrigram} + Stem ${selectedStem} = ${sum}
                        </div>
                        
                        <div style="text-align: center; margin: 20px 0;">
                            <div class="trigram-compact">
                                <div class="trigram-compact-symbol">${trigrams[upperTrigram].symbol}</div>
                                <div class="trigram-compact-name">${upperName} (${upperTrigram})</div>
                                <div>Upper</div>
                            </div>
                            <div style="font-size: 2rem; margin: 0 10px; display: inline-block; vertical-align: middle;">+</div>
                            <div class="trigram-compact">
                                <div class="trigram-compact-symbol">${trigrams[lowerTrigram].symbol}</div>
                                <div class="trigram-compact-name">${lowerName} (${lowerTrigram})</div>
                                <div>Lower</div>
                            </div>
                        </div>
                        
                        <div class="compact-line">
                            <strong>Present Hexagram:</strong> ${upperName}/${lowerName} #${kingWen} ${hexSymbol} - ${hexName}
                        </div>
                        
                        <div class="compact-line">
                            <strong>Moving Line:</strong> ${movingLine}
                        </div>
                        
                        <div class="compact-line">
                            <strong>Future Hexagram:</strong> ${names[transformedNum - 1].split('/')[0]}/${lowerName} #${transformedNum} ${transformedSymbol} - ${transformedName}
                        </div>
                    </div>
                    
                    <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap; justify-content: center;">
                        <button onclick="showRelevant(${lowerTrigram}, ${upperTrigram}, ${movingLine})" class="btn-info">🔗 Show Related Hexagrams</button>
                        <button onclick="prefillJournal(${kingWen}, ${transformedNum}, ${movingLine})" class="btn-success">📝 Add to Journal</button>
                    </div>
                </div>
            `;

            showRelevant(lowerTrigram, upperTrigram, movingLine);
        }

        // ... (keep all your other functions: showRelevant, prefillJournal, etc.)

        // Initialize
        renderTrigrams();
        displayJournal();
    </script>
</body>
</html>
