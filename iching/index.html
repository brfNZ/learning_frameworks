<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>I Ching Divination</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .book-cover {
            width: 80px;
            height: auto;
            object-fit: contain;
            margin: 0 auto 8px;
        }
        
        .i-ching-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .i-ching-table thead {
            background: #d1d5db;
        }
        
        .i-ching-table th {
            padding: 1rem;
            font-weight: bold;
            color: #1f2937;
            font-size: 0.875rem;
        }
        
        .i-ching-table th:first-child { text-align: left; white-space: normal; width: 180px; }
        .i-ching-table th:nth-child(2) { text-align: center; white-space: nowrap; width: 70px; }
        .i-ching-table th:nth-child(3) { text-align: center; white-space: nowrap; }
        .i-ching-table th:nth-child(4) { text-align: left; white-space: nowrap; }
        .i-ching-table th:nth-child(n+5) { text-align: center; width: 128px; font-size: 0.75rem; }
        
        .i-ching-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }
        
        .i-ching-table td:first-child { padding: 0.75rem; white-space: nowrap; text-align: left; }
        .i-ching-table td:nth-child(2) { padding: 0.75rem 0.5rem; white-space: nowrap; text-align: center; }
        .i-ching-table td:nth-child(3) { padding: 0.75rem 0.5rem; font-size: 2.5rem; white-space: nowrap; text-align: center; }
        .i-ching-table td:nth-child(n+5) { text-align: center; }
        
        .i-ching-table tbody tr:nth-child(even) { background: #f3f4f6; }
        .i-ching-table tbody tr:hover { background: #f9fafb; cursor: pointer; }
        .i-ching-table tbody tr.highlighted { 
            background: #dbeafe !important; 
            border-left: 4px solid #3b82f6;
        }
        
        .selection-btn {
            padding: 8px 10px;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            background: #fff;
            transition: all 0.2s;
            position: relative;
        }
        
        .selection-btn:hover {
            border-color: #3b82f6;
            background: #eff6ff;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .selection-btn.selected {
            border-color: #3b82f6;
            background: #dbeafe;
            font-weight: 700;
            color: #1e40af;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .trigram-number, .stem-number {
            position: absolute;
            top: 4px;
            left: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            color: #3b82f6;
        }
        
        .trigram-symbol {
            font-size: 2.25rem;
            line-height: 1;
            margin-bottom: 4px;
        }
        
        .trigram-english {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 2px;
        }
        
        .trigram-chinese {
            font-size: 0.65rem;
            color: #6b7280;
        }
        
        .stem-time {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 4px;
            margin-top: 20px;
        }
        
        .stem-chinese {
            font-size: 0.85rem;
            color: #6b7280;
        }
        
        .compact-btn {
            padding: 10px 8px;
        }
        
        .compact-number {
            font-size: 0.875rem;
            font-weight: 700;
            color: #3b82f6;
            margin-bottom: 4px;
        }
        
        .compact-time {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
        }
        
        /* Responsive sizing - smaller on larger screens */
        @media (min-width: 768px) {
            .selection-btn {
                padding: 6px 8px;
            }
            .trigram-symbol {
                font-size: 2.75rem;
            }
            .trigram-english {
                font-size: 0.7rem;
            }
            .trigram-chinese {
                font-size: 0.6rem;
            }
            .compact-btn {
                padding: 8px 6px;
            }
        }
        
        @media (min-width: 1024px) {
            .selection-btn {
                padding: 5px 6px;
            }
            .trigram-symbol {
                font-size: 3.25rem;
            }
            .trigram-english {
                font-size: 0.65rem;
            }
            .trigram-chinese {
                font-size: 0.55rem;
            }
            .trigram-number {
                font-size: 0.7rem;
                top: 3px;
                left: 5px;
            }
            .compact-btn {
                padding: 7px 5px;
            }
            .compact-time {
                font-size: 0.7rem;
            }
        }
        
        .hexagram-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            font-size: 5rem;
            line-height: 1;
        }
        
        .hex-arrow {
            font-size: 3rem;
            color: #10b981;
        }
        
        .section-card {
            background: white;
            border-radius: 12px;
            padding: 32px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            margin-bottom: 24px;
        }
        
        .result-box {
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
            border: 2px solid #86efac;
            border-radius: 12px;
            padding: 24px;
            margin-top: 24px;
        }
        
        .result-box h3 {
            font-size: 1.75rem;
            font-weight: 700;
            color: #166534;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .result-box p {
            margin: 10px 0;
            color: #166534;
            font-size: 1.05rem;
        }
        
        .result-box strong {
            color: #14532d;
        }
        
        .calculation-box {
            background: #fff;
            border: 2px solid #86efac;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            font-size: 1.1rem;
            font-weight: 600;
            color: #166534;
            text-align: center;
        }
        
        .btn-primary {
            padding: 14px 28px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: all 0.2s;
            box-shadow: 0 2px 4px rgba(59, 130, 246, 0.3);
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #2563eb;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.4);
        }
        
        .btn-primary:disabled {
            background: #9ca3af;
            cursor: not-allowed;
            opacity: 0.6;
            box-shadow: none;
        }
        
        .btn-toggle {
            padding: 10px 20px;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.95rem;
            transition: all 0.2s;
            margin-bottom: 12px;
        }
        
        .btn-toggle:hover {
            background: #7c3aed;
            transform: translateY(-1px);
        }
        
        .btn-success {
            padding: 12px 24px;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }
        
        .btn-secondary {
            padding: 12px 24px;
            background: #6b7280;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-secondary:hover {
            background: #4b5563;
            transform: translateY(-1px);
        }
        
        .btn-info {
            padding: 10px 20px;
            background: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
            font-size: 0.95rem;
        }
        
        .btn-info:hover {
            background: #2563eb;
        }
        
        .btn-danger {
            padding: 6px 14px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.875rem;
            font-weight: 600;
            transition: all 0.2s;
        }
        
        .btn-danger:hover {
            background: #dc2626;
        }
        
        .input-field {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        
        .input-field:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        textarea.input-field {
            min-height: 100px;
            resize: vertical;
        }
        
        .section-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .subsection-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen p-6">
    <div class="max-w-7xl mx-auto">
        <!-- Header -->
        <div class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800 mb-4">‚òØ I Ching Divination</h1>
            <p class="text-xl text-gray-600 mb-6">Consult the Oracle and Record Your Insights</p>
            <a href="reference.html" class="inline-block px-6 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold transition shadow-md hover:shadow-lg">
                üìñ View Reference Table
            </a>
        </div>

        <!-- Question Section -->
        <div class="section-card">
            <h2 class="section-title">üôè Your Question</h2>
            <p class="text-gray-600 mb-4">Focus on your question before consulting the oracle.</p>
            <input type="text" id="currentQuestion" class="input-field" placeholder="What guidance do I need today?">
        </div>

        <!-- Divination Section -->
        <div class="section-card">
            <h2 class="section-title">üé≤ Divination</h2>
            
            <!-- Trigram Selection -->
            <div class="mb-6">
                <div class="subsection-title">
                    <span>Select Lower Trigram</span>
                    <button class="btn-toggle" onclick="toggleSequence()">
                        <span id="sequenceLabel">Fu Xi</span> 
                    </button>
                </div>
                <div id="trigramGrid" class="grid grid-cols-2 md:grid-cols-4 gap-3">
                    <!-- Trigrams will be populated by JavaScript -->
                </div>
            </div>
            
            <!-- Stem Selection -->
            <div class="mb-6">
                <h3 class="subsection-title">Select Heavenly Stem (Time of Day)</h3>
                <div class="grid grid-cols-3 md:grid-cols-6 gap-2">
                    <div class="selection-btn compact-btn" data-value="1" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">1</div>
                        <div class="compact-time">11pm-1am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="2" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">2</div>
                        <div class="compact-time">1am-3am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="3" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">3</div>
                        <div class="compact-time">3am-5am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="4" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">4</div>
                        <div class="compact-time">5am-7am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="5" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">5</div>
                        <div class="compact-time">7am-9am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="6" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">6</div>
                        <div class="compact-time">9am-11am</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="7" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">7</div>
                        <div class="compact-time">11am-1pm</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="8" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">8</div>
                        <div class="compact-time">1pm-3pm</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="9" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">9</div>
                        <div class="compact-time">3pm-5pm</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="10" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">10</div>
                        <div class="compact-time">5pm-7pm</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="11" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">11</div>
                        <div class="compact-time">7pm-9pm</div>
                    </div>
                    <div class="selection-btn compact-btn" data-value="12" data-type="stem" onclick="selectStem(this)">
                        <div class="compact-number">12</div>
                        <div class="compact-time">9pm-11pm</div>
                    </div>
                </div>
            </div>
            
            <div class="text-center">
                <button id="divineBtn" class="btn-primary" onclick="divineTrigramStem()" disabled>‚ú® Divine Hexagram</button>
            </div>
            
            <div id="divResult"></div>
        </div>

        <!-- Relevant Hexagrams Table -->
        <div id="relevantSection" style="display: none;">
            <div class="section-card">
                <h2 class="section-title">üîó Relevant Hexagrams</h2>
                <div class="overflow-x-auto">
                    <table class="i-ching-table">
                        <thead>
                            <tr>
                                <th>Relationship</th>
                                <th>Gua number</th>
                                <th>Symbol</th>
                                <th>Name</th>
                                <th><img src="covers/iching.png" alt="The Book of Changes" class="book-cover">The Book of Changes</th>
                                <th><img src="covers/guide-iching.png" alt="A Guide to the I Ching" class="book-cover">A Guide to the I Ching</th>
                                <th><img src="covers/complete-iching.png" alt="The Complete I Ching.10th Ed" class="book-cover">The Complete I Ching.10th Ed</th>
                                <th><img src="covers/authentic-iching.png" alt="The Authentic I Ching" class="book-cover">The Authentic I Ching</th>
                                <th><img src="covers/iching-pt1.png" alt="I Ching Wilhelm Pt.1" class="book-cover">I Ching Pt.1</th>
                                <th><img src="covers/iching-pt2.png" alt="I Ching Wilhelm Pt.2" class="book-cover">I Ching Pt.2</th>
                                <th><img src="covers/taoist-iching.png" alt="Taoist I Ching" class="book-cover">Taoist I Ching</th>
                                <th><img src="covers/tao-organisation.png" alt="Tao of Organisation" class="book-cover">Tao of Organisation</th>
                                <th><img src="covers/astrology-iching.png" alt="Astrology of I Ching" class="book-cover">Astrology of I Ching</th>
                            </tr>
                        </thead>
                        <tbody id="relevantTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Journal Section -->
        <div class="section-card">
            <h2 class="section-title">üìì Journal Entry</h2>
            <p class="text-gray-600 mb-4">Review and save your divination.</p>
            
            <form onsubmit="addEntry(); return false;" class="mb-8">
                <div class="grid md:grid-cols-2 gap-6 mb-6">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Question</label>
                        <input type="text" id="journalQuestion" class="input-field" placeholder="Question will auto-fill from above" required>
                    </div>
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Hexagram</label>
                        <input type="text" id="hex" class="input-field" placeholder="Hexagram will auto-fill" required>
                    </div>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-semibold text-gray-700 mb-2">Notes & Interpretation</label>
                    <textarea id="notes" class="input-field" placeholder="Add your insights, interpretation, and reflections..."></textarea>
                </div>
                <div class="flex gap-3">
                    <button type="submit" class="btn-success">üíæ Save to Journal</button>
                    <button type="button" onclick="clearJournalForm()" class="btn-secondary">Clear Form</button>
                </div>
            </form>
            
            <h3 class="section-title" style="font-size: 1.25rem; margin-top: 32px;">Past Entries</h3>
            
            <div class="flex gap-3 mb-6">
                <button type="button" onclick="exportJournal()" class="btn-secondary">üì• Export to CSV</button>
            </div>
            
            <div class="overflow-x-auto">
                <table class="i-ching-table">
                    <thead>
                        <tr>
                            <th style="width: 100px;">Date</th>
                            <th>Question</th>
                            <th style="width: 200px;">Hexagram</th>
                            <th>Notes</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="journalBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script type="module">
        // Import shared data
        import { hexagrams, names, book1, book2, book3, book4, book5, book6, book7, book8, book9 } from './data.js';

        // I Ching Table class for hexagram lookup
        class IChingTable {
            constructor() {
                this.table = [
                    [1, 43, 14, 34, 9, 5, 26, 11],    // lower trigram 1
                    [10, 58, 38, 54, 61, 60, 41, 19], // lower trigram 2
                    [13, 49, 30, 55, 37, 63, 22, 36], // lower trigram 3
                    [25, 17, 21, 51, 42, 3, 27, 24],  // lower trigram 4
                    [44, 28, 50, 32, 57, 48, 18, 46], // lower trigram 5
                    [6, 47, 64, 40, 59, 29, 4, 7],    // lower trigram 6
                    [33, 31, 56, 62, 53, 39, 52, 15], // lower trigram 7
                    [12, 45, 35, 16, 20, 8, 23, 2]    // lower trigram 8
                ];
            }

            getHexagram(lowerTrigram, upperTrigram) {
                return this.table[lowerTrigram - 1][upperTrigram - 1];
            }
        }

        let selectedTrigram = null;
        let selectedStem = null;
        let currentSequence = 'fuxi'; // 'fuxi' or 'kingwen'
        let selectedTrigramNatural = null;

        // Trigram data with binary representations
        const trigrams = {
            1: { symbol: '‚ò∞', english: 'Heaven', chinese: 'Qian', binary: '111' },
            2: { symbol: '‚ò±', english: 'Lake', chinese: 'Dui', binary: '011' },
            3: { symbol: '‚ò≤', english: 'Fire', chinese: 'Li', binary: '101' },
            4: { symbol: '‚ò≥', english: 'Thunder', chinese: 'Zhen', binary: '001' },
            5: { symbol: '‚ò¥', english: 'Wind', chinese: 'Xun', binary: '110' },
            6: { symbol: '‚òµ', english: 'Water', chinese: 'Kan', binary: '010' },
            7: { symbol: '‚ò∂', english: 'Mountain', chinese: 'Gen', binary: '100' },
            8: { symbol: '‚ò∑', english: 'Earth', chinese: 'Kun', binary: '000' }
        };

        // Helper function to get trigram number from binary
        function getTrigramFromBinary(binary) {
            for (let [num, data] of Object.entries(trigrams)) {
                if (data.binary === binary) return parseInt(num);
            }
            return null;
        }

        // Calculate transformed hexagram (with moving line changed)
        function getTransformedHexagram(lowerTrigram, upperTrigram, movingLine) {
            const lowerBinary = trigrams[lowerTrigram].binary;
            const upperBinary = trigrams[upperTrigram].binary;
            const hexBinary = upperBinary + lowerBinary;
            
            // Flip the moving line (1-indexed from bottom)
            const lineIndex = 6 - movingLine; // Convert to 0-indexed from top
            const hexArray = hexBinary.split('');
            hexArray[lineIndex] = hexArray[lineIndex] === '0' ? '1' : '0';
            const newHexBinary = hexArray.join('');
            
            const newUpperBinary = newHexBinary.substring(0, 3);
            const newLowerBinary = newHexBinary.substring(3, 6);
            
            const newUpper = getTrigramFromBinary(newUpperBinary);
            const newLower = getTrigramFromBinary(newLowerBinary);
            
            return iChingTable.getHexagram(newLower, newUpper);
        }

        // Calculate opposite hexagram (all lines flipped)
        function getOppositeHexagram(lowerTrigram, upperTrigram) {
            const lowerBinary = trigrams[lowerTrigram].binary;
            const upperBinary = trigrams[upperTrigram].binary;
            const hexBinary = upperBinary + lowerBinary;
            
            // Flip all lines
            const flipped = hexBinary.split('').map(bit => bit === '0' ? '1' : '0').join('');
            
            const newUpperBinary = flipped.substring(0, 3);
            const newLowerBinary = flipped.substring(3, 6);
            
            const newUpper = getTrigramFromBinary(newUpperBinary);
            const newLower = getTrigramFromBinary(newLowerBinary);
            
            return iChingTable.getHexagram(newLower, newUpper);
        }

        // Calculate nuclear/mutual hexagram (inner hexagram)
        function getNuclearHexagram(lowerTrigram, upperTrigram) {
            const lowerBinary = trigrams[lowerTrigram].binary;
            const upperBinary = trigrams[upperTrigram].binary;
            const hexBinary = upperBinary + lowerBinary;
            
            // Lines 2,3,4 become lower trigram; lines 3,4,5 become upper trigram
            // hexBinary is indexed from top: [0]=line6, [1]=line5, [2]=line4, [3]=line3, [4]=line2, [5]=line1
            const newLowerBinary = hexBinary[3] + hexBinary[2] + hexBinary[1]; // lines 3,4,5 from bottom
            const newUpperBinary = hexBinary[4] + hexBinary[3] + hexBinary[2]; // lines 2,3,4 from bottom
            
            const newUpper = getTrigramFromBinary(newUpperBinary);
            const newLower = getTrigramFromBinary(newLowerBinary);
            
            return iChingTable.getHexagram(newLower, newUpper);
        }

        // Reverse hexagram (upside down) - swap upper and lower trigrams
        function getReverseHexagram(lowerTrigram, upperTrigram) {
            return iChingTable.getHexagram(upperTrigram, lowerTrigram);
        }

        // Fu Xi: natural order with natural numbering
        const fuxiOrder = [1, 2, 3, 4, 5, 6, 7, 8]; // Qian, Dui, Li, Zhen, Xun, Kan, Gen, Kun

        // King Wen: rearranged order
        const kingWenOrder = [4, 5, 3, 8, 2, 1, 6, 7]; // Zhen, Xun, Li, Kun, Dui, Qian, Kan, Gen

        // Render trigrams based on current sequence
        function renderTrigrams() {
            const order = currentSequence === 'fuxi' ? fuxiOrder : kingWenOrder;
            const grid = document.getElementById('trigramGrid');
            grid.innerHTML = '';

            order.forEach((naturalTrigramValue, index) => {
                const displayNumber = index + 1; // Always display as 1-8 in order
                const trigram = trigrams[naturalTrigramValue];
                const isSelected = selectedTrigram === displayNumber ? 'selected' : '';
                
                const btn = document.createElement('div');
                btn.className = `selection-btn ${isSelected}`;
                btn.setAttribute('data-value', displayNumber); // Store display number
                btn.setAttribute('data-natural', naturalTrigramValue); // Store natural value for lookup
                btn.setAttribute('data-type', 'trigram');
                btn.onclick = function() { selectTrigram(this); };
                btn.innerHTML = `
                    <div class="trigram-number">${displayNumber}</div>
                    <div class="trigram-symbol">${trigram.symbol}</div>
                    <div class="trigram-english">${trigram.english}</div>
                    <div class="trigram-chinese">${trigram.chinese}</div>
                `;
                grid.appendChild(btn);
            });
        }

        // Toggle sequence
        window.toggleSequence = function() {
            currentSequence = currentSequence === 'fuxi' ? 'kingwen' : 'fuxi';
            document.getElementById('sequenceLabel').textContent = 
                currentSequence === 'fuxi' ? 'Fu Xi' : 'King Wen';
            renderTrigrams();
        }

        // Journal data and functions
        let journal = JSON.parse(localStorage.getItem('ichingJournal')) || [];

        window.addEntry = function() {
            const question = document.getElementById('journalQuestion').value;
            const hex = document.getElementById('hex').value;
            const notes = document.getElementById('notes').value;
            if (!question || !hex) return alert('Please add question and hexagram!');
            
            const entry = { id: Date.now(), date: new Date().toISOString().split('T')[0], question, hex, notes };
            journal.unshift(entry);
            localStorage.setItem('ichingJournal', JSON.stringify(journal));
            displayJournal();
            clearJournalForm();
            alert('Entry saved to journal!');
        }

        window.clearJournalForm = function() {
            document.getElementById('journalQuestion').value = '';
            document.getElementById('hex').value = '';
            document.getElementById('notes').value = '';
        }

        function displayJournal() {
            const tbody = document.getElementById('journalBody');
            tbody.innerHTML = '';
            if (journal.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding:20px; color:#6b7280;">No entries yet. Start by entering a question and performing a divination.</td></tr>';
                return;
            }
            journal.forEach(entry => {
                const row = tbody.insertRow();
                row.onclick = function() {
                    // Remove highlight from all rows
                    tbody.querySelectorAll('tr').forEach(r => r.classList.remove('highlighted'));
                    // Add highlight to clicked row
                    this.classList.add('highlighted');
                };
                row.innerHTML = `
                    <td>${entry.date}</td>
                    <td>${entry.question}</td>
                    <td>${entry.hex}</td>
                    <td>${entry.notes || '-'}</td>
                    <td style="text-align:center;"><button onclick="event.stopPropagation(); deleteEntry(${entry.id})" class="btn-danger">Delete</button></td>
                `;
            });
        }

        window.deleteEntry = function(id) {
            if (!confirm('Delete this journal entry?')) return;
            journal = journal.filter(e => e.id !== id);
            localStorage.setItem('ichingJournal', JSON.stringify(journal));
            displayJournal();
        }

        window.exportJournal = function() {
            if (journal.length === 0) {
                alert('No entries to export!');
                return;
            }
            const csv = ['Date,Question,Hexagram,Notes'].concat(journal.map(e => `${e.date},"${e.question}","${e.hex}","${e.notes || ''}"`)).join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'iching-journal.csv';
            a.click();
            URL.revokeObjectURL(url);
        }

        // Divination functions with toggle behavior
        window.selectTrigram = function(btn) {
            const value = parseInt(btn.getAttribute('data-value')); // Display number for calculation
            
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                selectedTrigram = null;
                selectedTrigramNatural = null;
            } else {
                document.querySelectorAll('.selection-btn[data-type="trigram"]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedTrigram = value; // Use display number in calculation
                selectedTrigramNatural = parseInt(btn.getAttribute('data-natural')); // For hexagram lookup
            }
            
            checkSelection();
        }

        window.selectStem = function(btn) {
            const value = parseInt(btn.getAttribute('data-value'));
            
            if (btn.classList.contains('selected')) {
                btn.classList.remove('selected');
                selectedStem = null;
            } else {
                document.querySelectorAll('.selection-btn[data-type="stem"]').forEach(b => b.classList.remove('selected'));
                btn.classList.add('selected');
                selectedStem = value;
            }
            
            checkSelection();
        }

        function checkSelection() {
            const divineBtn = document.getElementById('divineBtn');
            if (selectedTrigram && selectedStem) {
                divineBtn.disabled = false;
            } else {
                divineBtn.disabled = true;
            }
        }

        window.divineTrigramStem = function() {
            if (!selectedTrigram || !selectedStem) return alert('Please select both a trigram and a stem!');

            const lowerTrigram = selectedTrigramNatural; // Use natural value for hexagram lookup
            const sum = selectedTrigram + selectedStem; // Use display number for calculation
            let upperTrigram = sum % 8;
            if (upperTrigram === 0) upperTrigram = 8;
            let movingLine = sum % 6 || 6;
            
            // Use IChingTable to get the hexagram number
            const kingWen = iChingTable.getHexagram(lowerTrigram, upperTrigram);
            const hexSymbol = hexagrams[kingWen - 1];
            const hexName = names[kingWen - 1];

            // Calculate transformed hexagram
            const transformedNum = getTransformedHexagram(lowerTrigram, upperTrigram, movingLine);
            const transformedSymbol = hexagrams[transformedNum - 1];
            const transformedName = names[transformedNum - 1];

            // Get names for display
            const lowerName = trigrams[lowerTrigram].chinese;
            const upperName = trigrams[upperTrigram].chinese;
            const stemTime = stemTimes[selectedStem];

            document.getElementById('divResult').innerHTML = `
                <div class="result-box">
                    <h3>‚ú® Divination Result</h3>
                    
                    <p><strong>Lower Trigram:</strong> ${lowerName} (${lowerTrigram})</p>
                    <p><strong>Heavenly Stem:</strong> ${stemTime} (${selectedStem})</p>
                    <p><strong>Sum:</strong> ${lowerTrigram} + ${selectedStem} = ${sum}</p>
                    <p><strong>Upper Trigram:</strong> ${upperName} (${upperTrigram})</p>
                    
                    <div class="hexagram-display">
                        <div style="text-align: center;">
                            <div>${hexSymbol}</div>
                            <div style="font-size: 1rem; margin-top: 8px;">#${kingWen}</div>
                        </div>
                        <div class="hex-arrow">‚Üí</div>
                        <div style="text-align: center;">
                            <div>${transformedSymbol}</div>
                            <div style="font-size: 1rem; margin-top: 8px;">#${transformedNum}</div>
                        </div>
                    </div>
                    
                    <p><strong>Present Hexagram:</strong> #${kingWen} ${hexSymbol} - ${hexName}</p>
                    <p><strong>Moving Line:</strong> ${movingLine}</p>
                    <p><strong>Future Hexagram:</strong> #${transformedNum} ${transformedSymbol} - ${transformedName}</p>
                    
                    <div style="margin-top:20px; display:flex; gap:12px; flex-wrap:wrap;">
                        <button onclick="showRelevant(${lowerTrigram}, ${upperTrigram}, ${movingLine})" class="btn-info">üîó Show Related Hexagrams</button>
                        <button onclick="prefillJournal(${kingWen}, ${transformedNum}, ${movingLine})" class="btn-success">üìù Add to Journal</button>
                    </div>
                </div>
            `;

            showRelevant(lowerTrigram, upperTrigram, movingLine);
        }

        window.showRelevant = function(lowerTrigram, upperTrigram, movingLine) {
            const original = iChingTable.getHexagram(lowerTrigram, upperTrigram);
            const transformed = getTransformedHexagram(lowerTrigram, upperTrigram, movingLine);
            const opposite = getOppositeHexagram(lowerTrigram, upperTrigram);
            const reverse = getReverseHexagram(lowerTrigram, upperTrigram);
            const nuclear = getNuclearHexagram(lowerTrigram, upperTrigram);

            const related = [
                { label: 'Present (Original)', num: original },
                { label: 'Future (Transformed)', num: transformed },
                { label: 'Opposite (Inverse)', num: opposite },
                { label: 'Reverse', num: reverse },
                { label: 'Nuclear (Mutual)', num: nuclear }
            ];

            const tbody = document.getElementById('relevantTableBody');
            tbody.innerHTML = '';
            
            related.forEach(item => {
                const n = item.num;
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td style="font-weight: 600; color: #374151;">${item.label}</td>
                    <td>${n}</td>
                    <td>${hexagrams[n - 1]}</td>
                    <td>${names[n - 1]}</td>
                    <td>${book1[n - 1] || '-'}</td>
                    <td>${book2[n - 1] || '-'}</td>
                    <td>${book3[n - 1] || '-'}</td>
                    <td>${book4[n - 1] || '-'}</td>
                    <td>${book5[n - 1] || '-'}</td>
                    <td>${book6[n - 1] || '-'}</td>
                    <td>${book7[n - 1] || '-'}</td>
                    <td>${book8[n - 1] || '-'}</td>
                    <td>${book9[n - 1] || '-'}</td>
                `;
            });
            
            document.getElementById('relevantSection').style.display = 'block';
        }

        window.prefillJournal = function(kingWen, transformedNum, movingLine) {
            const question = document.getElementById('currentQuestion').value;
            if (!question.trim()) {
                alert('Please enter your question first!');
                document.getElementById('currentQuestion').focus();
                return;
            }
            
            const hex = `#${kingWen} ${hexagrams[kingWen - 1]} ‚Üí #${transformedNum} ${hexagrams[transformedNum - 1]} (Line ${movingLine})`;
            
            // Auto-fill the journal form
            document.getElementById('journalQuestion').value = question;
            document.getElementById('hex').value = hex;
            document.getElementById('notes').focus();
            
            // Scroll to journal section
            window.scrollTo({ top: document.querySelector('#journalQuestion').offsetTop - 100, behavior: 'smooth' });
        }

        // Initialize
        renderTrigrams();
        displayJournal();
    </script>
</body>
</html>
