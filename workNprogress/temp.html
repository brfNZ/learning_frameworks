<!DOCTYPE html>
<html lang="en">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>My Trading Journal</title>
 <style>
  :root {
    --primary: #8cc2ee;
    --primary-dark: #64a5df;
    --primary-text: #2c5f8d;
    --primary-light-bg: #f5f9ff;
    --success: #A8D5A8;
    --success-dark: #95C895;
    --success-text: #4a7a4a;
    --success-light-bg: #fefffe;
    --danger: #E8A5A5;
    --danger-dark: #D99494;
    --danger-text: #8d4a4a;
    --danger-light-bg: #fffefe;
    --info: #B8D0E8;
    --light: #F8F9FB;
    --dark: #5A6B7A;
    --gradient: linear-gradient(135deg, #FAFBFC 0%, #F0F2F5 100%);
    --table-header-gradient: #5A9BD4;
    --radius: 12px;
    --radius-sm: 8px;
    --shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    --transition: all 0.3s ease;
  }

  body {
    background: var(--gradient);
    color: var(--dark);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
    padding: 15px;
    margin: 0 auto;
    min-height: 100vh;
    max-width: 900px;
  }

  h1 { text-align: center; margin-bottom: 20px; color: var(--dark); font-size: 24px; font-weight: 600; }

  .nav-buttons, .date-filter-container {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-bottom: 20px;
    flex-wrap: wrap;
  }

  .nav-button, .filter-btn {
    background-color: white;
    color: var(--primary);
    padding: 8px 16px;
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 14px;
    font-weight: 500;
    transition: var(--transition);
  }
  .nav-button.active, .filter-btn.active {
    background-color: var(--primary);
    color: white;
  }
  .nav-button:hover, .filter-btn:hover {
    background-color: var(--primary-dark);
    color: white;
    border-color: var(--primary-dark);
  }
  .filter-btn.active { box-shadow: 0 2px 8px rgba(140, 194, 238, 0.3); }

  .section { display: none; }
  .section.active { display: block; }

  .question { margin: 8px 0; }
  .question + .question { margin-top: 4px; }

  select { padding: 6px 8px; height: 36px; font-size: 13px; line-height: 1.4; }
  select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(123, 179, 224, 0.1); }

  .section-header {
    background: var(--primary-light-bg);
    color: var(--primary-text);
    padding: 10px 15px;
    border: 2px solid var(--primary);
    border-radius: var(--radius);
    margin: 2px 0 4px 0;
    text-align: center;
    font-weight: 600;
    font-size: 14px;
  }
  .section-header.positive {
    background: #f6fff6;
    color: var(--success-text);
    border: 2px solid var(--success);
  }
  .section-header.danger {
    background: #fcf5f6;
    color: var(--danger-text);
    border: 2px solid var(--danger);
  }
  .section-header.collapsible {
    cursor: pointer;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  .section-header.collapsible:hover {
    background: #d1ebfd;
    border-color: var(--primary-dark);
  }
  .section-header.collapsible .arrow {
    transition: transform 0.3s ease;
    font-size: 16px;
  }
  .section-header.collapsible.expanded .arrow { transform: rotate(180deg); }

  .collapsible-content {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.4s ease;
  }
  .collapsible-content.expanded { max-height: 3000px; }

  .rating-container {
    display: flex;
    justify-content: center;
    gap: 3px;
    align-items: center;
    margin: 6px 0;
  }
  .emoji-btn {
    width: 32px;
    height: 32px;
    padding: 2px;
    border-radius: var(--radius);
    transition: var(--transition);
    font-size: 22px;
    line-height: 1;
    font-weight: 500;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px solid var(--primary);
    background-color: var(--primary-light-bg);
    color: var(--primary-text);
    cursor: pointer;
  }
  .emoji-btn:hover { border-color: var(--primary-dark); background-color: #d1ebfd; }
  .emoji-btn.selected {
    background-color: var(--primary);
    border-color: var(--primary-dark);
    color: white;
    border-width: 3px;
    box-shadow: 0 0 0 2px rgba(123, 179, 224, 0.2);
  }
  /* Scale down X and O to match checkmark size */
  .rating-container .emoji-btn:nth-child(1),
  .rating-container .emoji-btn:nth-child(2) {
    font-size: 18px;
  }

  .rating-question, .green-flag-container, .red-flag-container {
    background: white;
    border-radius: var(--radius);
    padding: 10px;
    margin: 6px 0;
    border: 1px solid #E5E7EB;
    box-shadow: var(--shadow);
  }
  .rating-question label { text-align: center; font-weight: 500; margin-bottom: 6px; font-size: 13px; }

  label {
    display: block;
    margin-bottom: 4px;
    font-weight: 500;
    color: var(--dark);
    font-size: 13px;
  }
  input[type="text"], input[type="date"], input[type="number"], textarea, select {
    width: 100%;
    padding: 8px 10px;
    background-color: white;
    color: var(--dark);
    border: 2px solid #E5E7EB;
    border-radius: var(--radius-sm);
    font-size: 14px;
    box-sizing: border-box;
    transition: var(--transition);
  }
  input:focus, textarea:focus, select:focus {
    border-color: var(--primary);
    outline: none;
    box-shadow: 0 0 0 3px rgba(123, 179, 224, 0.1);
  }
  textarea { height: 60px; resize: vertical; }

  .green-flag-grid, .red-flag-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
    gap: 8px;
    margin-top: 10px;
  }
  .green-flag-btn, .red-flag-btn {
    padding: 8px 12px;
    border-radius: var(--radius);
    cursor: pointer;
    font-size: 12px;
    font-weight: 500;
    transition: var(--transition);
    display: flex;
    align-items: center;
    gap: 6px;
    justify-content: center;
  }
  .green-flag-btn {
    border: 2px solid var(--success);
    color: var(--success-text);
    background-color: var(--success-light-bg);
  }
  .green-flag-btn:hover, .green-flag-btn.active {
    background-color: var(--success);
    color: white;
    box-shadow: 0 2px 8px rgba(168, 213, 168, 0.3);
  }
  .red-flag-btn {
    border: 2px solid var(--danger);
    color: var(--danger-text);
    background-color: var(--danger-light-bg);
  }
  .red-flag-btn:hover, .red-flag-btn.active {
    background-color: var(--danger);
    color: white;
    box-shadow: 0 2px 8px rgba(232, 165, 165, 0.3);
  }

  /* â†â†â† CRITICAL: Weekly table mobile scroll â†’â†’â†’ */
  #weeklyTable {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 15px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
  }
  table {
    width: 100%;
    min-width: 850px;           /* forces horizontal scroll on small screens */
    border-collapse: collapse;
    background: white;
    border-radius: var(--radius);
    overflow: hidden;
    box-shadow: var(--shadow);
    font-size: 13px;
  }
  th, td {
    border: 1px solid #E5E7EB;
    padding: 8px 10px;
    text-align: left;
    box-sizing: border-box;
  }
  th {
    background: linear-gradient(180deg, var(--table-header-gradient) 0%, var(--primary) 100%);
    color: white;
    font-weight: 500;
    font-size: 12px;
  }
  td { background-color: white; color: var(--dark); }
  tr:nth-child(even) td { background-color: #FAFBFC; }

  .no-data {
    text-align: center;
    font-style: italic;
    color: var(--dark);
    margin-top: 15px;
    padding: 15px;
    background: white;
    border-radius: var(--radius);
    border: 2px dashed #E5E7EB;
    font-size: 14px;
  }

  .red-flags-column { max-width: 120px; font-size: 11px; }
  .red-flag-tag, .green-flag-tag {
    display: inline-block;
    padding: 2px 6px;
    margin: 1px;
    border-radius: 4px;
    font-size: 10px;
  }
  .red-flag-tag { background-color: var(--danger); color: white; }
  .green-flag-tag { background-color: var(--success); color: white; }

  th:nth-child(1), td:nth-child(1) { max-width: 50px; white-space: nowrap; }
  th:nth-last-child(4), td:nth-last-child(4) { width: 55px; }
  th:nth-child(6), td:nth-child(6) { max-width: 180px; font-size: 11px; overflow: hidden; text-overflow: ellipsis; }
  th:nth-child(7), td:nth-child(7) { max-width: 120px; font-size: 11px; overflow: hidden; text-overflow: ellipsis; }

  .save-btn {
    display: block;
    width: 20%;
    margin: 8px auto 0;
    padding: 12px 24px;
    font-size: 16px;
    font-weight: 600;
    background: var(--success);
    color: white;
    border: 2px solid var(--success);
    border-radius: var(--radius);
    box-shadow: 0 2px 10px rgba(168, 213, 168, 0.3);
    transition: var(--transition);
    cursor: pointer;
  }
  .save-btn:hover {
    background: var(--success-dark);
    border-color: var(--success-dark);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(168, 213, 168, 0.4);
  }
</style>
</head>
<body>
 <h1>Trading Journal</h1>

<!-- MONTHLY GOAL â€“ fits long text, always shows bar -->
<div class="section-header positive"
     style="margin:0 auto 15px; max-width:540px; font-size:13px; display:flex; flex-wrap:wrap; align-items:center; gap:8px;">

  <!-- title (wraps) -->
  <span id="goalTitle" style="cursor:pointer; white-space:normal; line-height:1.3; min-width:0;"
        title="Click to edit">ğŸ¯ string of 5 reversal trades, no disasters</span>
  <input id="goalTitleEdit" type="text" style="display:none; width:140px; font-size:12px;"
         onblur="saveGoalTitle()" onkeyup="if(event.key==='Enter') this.blur()">

  <!-- smaller number boxes -->
  <label style="font-size:12px;">Target
    <input id="goalTarget" type="number" min="1" value="2" style="width:46px; font-size:12px; text-align:center"
           oninput="updateGoalBar()">
  </label>
  <label style="font-size:12px;">Done
    <input id="goalDone"  type="number" min="0" value="100" style="width:46px; font-size:12px; text-align:center"
           oninput="updateGoalBar()">
  </label>

  <!-- progress bar (always visible) -->
  <div style="flex:1 1 120px; height:10px; background:#e0e0e0; border-radius:5px; overflow:hidden; min-width:80px;">
    <div id="goalBar" style="height:100%; width:0%; background:var(--success); transition:width .3s"></div>
  </div>

  <!-- percent -->
  <span id="goalPct" style="font-size:12px; font-weight:600; color:var(--success-text)">0 %</span>
</div>
 
 <!-- Navigation Buttons -->
 <div class="nav-buttons">
 <button class="nav-button active" onclick="showSection('daily')">Daily Entry</button>
 <button class="nav-button" onclick="showSection('weekly')">Trading History</button>
 <button class="nav-button" id="saveTopBtn" style="background: var(--success); color: white; border-color: var(--success);" onclick="saveEntry()">Save</button>
 <button class="nav-button" id="exportBtn" style="display: none; background: var(--success); color: white; border-color: var(--success);" onclick="exportToCSV()">Export CSV</button> 
 </div>

 <div id="daily" class="section active">
 <form id="dailyForm">
 <!-- Compact layout: Date and Market on same line -->
 <div style="display: flex; gap: 10px; margin: 12px 0;">
 <div class="question" style="margin: 0; flex: 0 0 180px;">
 <label for="date">Date:</label>
 <input type="date" id="date" name="date">
 </div>
 <div class="question" style="margin: 0; flex: 1;">
 <label for="market_timeframe">Market & Timeframe:</label>
 <input type="text" id="market_timeframe" name="market_timeframe" placeholder="eg. HK, USD/JPY - 1H, 4H, Daily...">
 </div>
 </div>
 <div id="market-conditions-container"></div>

 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>â° TIMING & TRIGGER</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Entry Quality & Timing Score</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('timing', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('timing', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('timing', 1)">âœ”ï¸</button>
 </div>
 </div>
 <div id="timing-dropdown-container"></div>
 </div>
 
 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>âš ï¸ RISK MANAGEMENT</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Risk Control & Discipline</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('risk', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('risk', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('risk', 1)">âœ”ï¸</button>
 </div>
 </div>
 <div id="risk-dropdown-container"></div>
 
 <div class="question">
 <label for="risk_percent">Risk %:</label>
 <input type="number" step="0.1" placeholder="1.0%" id="risk_percent" value="1.0">
 </div>
 </div>
 
 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>ğŸ¯ ANALYSIS & SETUP</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Setup Quality & Analysis</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('analysis', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('analysis', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('analysis', 1)">âœ”ï¸</button>
 </div>
 </div>
 <div id="analysis-dropdown-container"></div>
 <div id="setup-dropdown-container"></div>
 
 <div class="question"> 
 <label for="setup_details">Setup Details (optional):</label>
 <input type="text" id="setup_details" placeholder="e.g., hanging man, at 1.2500 resistance...">
 </div>
 </div>

 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>ğŸ§  DISCIPLINE & PSYCHOLOGY</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Mental State & Discipline</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('discipline', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('discipline', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('discipline', 1)">âœ”ï¸</button>
 </div>
 </div>
 <div id="discipline-dropdown-container"></div>
 </div>
 
 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>ğŸšª EXIT STRATEGY</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Exit Timing & Execution</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('exit', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('exit', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('exit', 1)">âœ”ï¸</button>
 </div>
 </div>
 <div id="exit-dropdown-container"></div>
 </div>
 
 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>ğŸ’° RESULTS & REWARD</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="rating-question">
 <label>Risk/Reward Outcome</label>
 <div class="rating-container">
 <button type="button" class="emoji-btn" onclick="setRating('results', -1)">âŒ</button>
 <button type="button" class="emoji-btn" onclick="setRating('results', 0)">âšª</button>
 <button type="button" class="emoji-btn" onclick="setRating('results', 1)">âœ”ï¸</button>
 </div>
 </div>
 
 <div class="question">
 <label for="r_multiple">R value</label>
 <input type="number" step="0.1" placeholder="+5.0 or -1.0" id="r_multiple" value="1.0">
 </div>
 </div>

 <div class="section-header collapsible positive" onclick="toggleMainSection('green-flags')">
 <span>âœ”ï¸ GREEN TICKS - What I Did Well</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content" id="green-flags-content">
 <div class="green-flag-container">
 <label style="text-align: center; color: var(--green-flag-dark); font-size: 14px; font-weight: 500;">Celebrate wins to build discipline & edge</label>
 <div class="green-flag-grid">
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('followed_plan')">
 <span class="icon">ğŸ“</span> Followed Plan
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('premarket_analysis')">
 <span class="icon">ğŸ”</span> Pre-Market Analysis
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('waited_setup')">
 <span class="icon">â³</span> Waited for Setup
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('correct_timeframes')">
 <span class="icon">ğŸ“Š</span> Correct Timeframes
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('perfect_position_size')">
 <span class="icon">ğŸ¯</span> Perfect Position
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('quick_loss_cut')">
 <span class="icon">ğŸ›‘</span> Quick Loss Cut
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('hit_profit_target')">
 <span class="icon">ğŸ¯</span> Hit Profit Target
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('avoided_chasing')">
 <span class="icon">ğŸƒâ€â™‚ï¸</span> Avoided Chasing
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('emotional_control')">
 <span class="icon">ğŸ˜Œ</span> Emotional Control
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('documented_trades')">
 <span class="icon">ğŸ“</span> Documented Trades
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('post_trade_analysis')">
 <span class="icon">ğŸ¤”</span> Post-Trade Analysis
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('applied_lessons')">
 <span class="icon">ğŸ’¡</span> Applied Lessons
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('stuck_risk_limits')">
 <span class="icon">âš–ï¸</span> Stuck to Risk Limits
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('waited_confluence')">
 <span class="icon">ğŸ”„</span> Multi-Timeframe Confluence
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('reviewed_last_trade')">
 <span class="icon">ğŸ”</span> Reviewed Last Trade
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('neutral_mindset')">
 <span class="icon">ğŸ§ </span> Neutral Mindset (No Tilt)
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('documented_rationale')">
 <span class="icon">ğŸ“</span> Documented Rationale
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('exited_on_plan')">
 <span class="icon">ğŸ¯</span> Exited on Plan
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('adapted_conditions')">
 <span class="icon">ğŸ”„</span> Adapted to Conditions
 </button>
 <button type="button" class="green-flag-btn" onclick="toggleGreenFlag('celebrated_small_win')">
 <span class="icon">ğŸ‰</span> Celebrated Small Win
 </button> 
 </div>
 </div>
 </div>

 <div class="section-header collapsible danger" onclick="toggleMainSection('red-flags')">
 <span>ğŸš© RED FLAGS</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content" id="red-flags-content">
 <div class="red-flag-container">
 <label style="text-align: center; color: var(--red-flag-dark); font-size: 14px; font-weight: 500;">Flag risks to break bad habits & protect capital</label>
 <div class="red-flag-grid">
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('revenge')">
 <span class="icon">ğŸ˜¡</span> Revenge Trading
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('overtrading')">
 <span class="icon">ğŸ”„</span> Overtrading
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('fomo')">
 <span class="icon">ğŸ˜°</span> FOMO Entry
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('moved_stop')">
 <span class="icon">ğŸ“</span> Moved Stop Loss
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('added_loser')">
 <span class="icon">â•</span> Added to Loser
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('no_plan')">
 <span class="icon">â“</span> No Trading Plan
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('ignored_risk')">
 <span class="icon">âš ï¸</span> Ignored Risk Rules
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('trader_error')">
 <span class="icon">ğŸ’¢</span> Trader error
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('news_trade')">
 <span class="icon">ğŸ“°</span> News Reaction Trade
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('hope_hold')">
 <span class="icon">ğŸ¤</span> Hope & Hold
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('early_exit')">
 <span class="icon">ğŸƒ</span> Early Exit (Fear)
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('herd_behavior')">
 <span class="icon">ğŸ‘¥</span> Herd Behavior
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('loss_aversion')">
 <span class="icon">ğŸ“‰</span> Held Loser
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('overconfidence')">
 <span class="icon">ğŸ˜</span> Overconfident
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('confirmation_bias')">
 <span class="icon">ğŸ”</span> Confirmation Bias
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('illusion_control')">
 <span class="icon">ğŸ®</span> Illusion of Control
 </button>
 <button type="button" class="red-flag-btn" onclick="toggleRedFlag('social_influence')">
 <span class="icon">ğŸ“±</span> Social Impulse
 </button> 
 </div>
 </div>
 </div>

 <div class="section-header collapsible" onclick="toggleSection(this)">
 <span>ğŸ’¡ KEY TAKEAWAY</span>
 <span class="arrow">â–¼</span>
 </div>
 <div class="collapsible-content">
 <div class="question">
 <label for="key_takeaway">Key lesson learned:</label>
 <textarea id="key_takeaway" placeholder="What's the most important lesson from today's trading?"></textarea>
 </div>
 </div>
 
 <div style="text-align: center; margin-top: 20px;">
 <button type="button" class="save-btn" onclick="saveEntry()">SAVE Day Entry</button>
 </div>

 </form>
 </div>
 
 <!-- Weekly Review Section -->
 <div id="weekly" class="section">
 <!-- Date Range Filter Buttons -->
 <div class="date-filter-container">
 <button class="filter-btn timeframe-btn active" onclick="filterWeeklyData('last30')">Last 30 Days</button>
 <button class="filter-btn timeframe-btn" onclick="filterWeeklyData('thisWeek')">This Week</button>
 <button class="filter-btn timeframe-btn" onclick="filterWeeklyData('all')">All Time</button>
 </div>
 
 <!-- Column Visibility Toggles -->
 <div class="section-header" style="margin-top: 20px;">Column Visibility</div>
 <div class="date-filter-container" style="margin-bottom: 15px;">
 <button class="filter-btn column-btn" id="toggle-timing" onclick="toggleColumn('timing')">T - Timing</button>
 <button class="filter-btn column-btn" id="toggle-risk" onclick="toggleColumn('risk')">R - Risk</button>
 <button class="filter-btn column-btn" id="toggle-analysis" onclick="toggleColumn('analysis')">A - Analysis</button>
 <button class="filter-btn column-btn" id="toggle-discipline" onclick="toggleColumn('discipline')">D - Discipline</button>
 <button class="filter-btn column-btn" id="toggle-exit" onclick="toggleColumn('exit')">E - Exit</button>
 <button class="filter-btn column-btn" id="toggle-results" onclick="toggleColumn('results')">R - Results</button>
 </div>
 <div class="date-filter-container" style="margin-bottom: 15px;">
 <button class="filter-btn column-btn" id="toggle-setup" onclick="toggleColumn('setup')">Setup</button>
 <button class="filter-btn column-btn" id="toggle-market" onclick="toggleColumn('market')">Market</button>
 <button class="filter-btn column-btn" id="toggle-rvalue" onclick="toggleColumn('rvalue')">R value</button>
 <button class="filter-btn column-btn active" id="toggle-greenflags" onclick="toggleColumn('greenflags')">Green Flags</button>
 <button class="filter-btn column-btn active" id="toggle-redflags" onclick="toggleColumn('redflags')">Red Flags</button>
 <button class="filter-btn column-btn" id="toggle-takeaway" onclick="toggleColumn('takeaway')">Takeaway</button>
 </div>
 
 <div id="weeklyTable"></div>
 </div>

 <script>
 // Helper to get local YYYY-MM-DD string consistently (fixes timezone bug)
 function getLocalDateString() {
 const now = new Date();
 const year = now.getFullYear();
 const month = String(now.getMonth() + 1).padStart(2, '0');
 const day = String(now.getDate()).padStart(2, '0');
 return `${year}-${month}-${day}`;
 }

 // Config for T.R.A.D.E.R text dropdowns
 const traderDropdowns = [
 { id: 'market_conditions', label: 'Market Conditions', category: 'market', options: [
 { value: '', text: 'Select Condition' },
 { value: 'strong_uptrend', text: 'ğŸ“ˆ Strong Uptrend' },
 { value: 'strong_downtrend', text: 'ğŸ“‰ Strong Downtrend' },
 { value: 'ranging_sideways', text: 'â†”ï¸ Ranging/Sideways' },
 { value: 'high_volatility', text: 'âš¡ High Volatility' },
 { value: 'low_volatility', text: 'ğŸ˜´ Low Volatility' }
 ] },
 { id: 'timing_dropdown', label: 'Timing Assessment', category: 'timing', options: [
 { value: '', text: 'Select...' },
 { value: 'Too early', text: 'Too early' },
 { value: 'Perfect timing', text: 'Perfect timing' },
 { value: 'Missed setup', text: 'Missed setup' },
 { value: 'Late', text: 'Late' }
 ] },
 { id: 'risk_dropdown', label: 'Risk Assessment', category: 'risk', options: [
 { value: '', text: 'Select...' },
 { value: 'Small risk', text: 'Small risk' },
 { value: 'Position too big', text: 'Position too big' },
 { value: 'Just right', text: 'Just right' },
 ] },
 { id: 'analysis_quality_dropdown', label: 'Setup Quality', category: 'analysis_quality', options: [
 { value: '', text: 'Select...' },
 { value: 'Perfect recognition', text: 'Perfect recognition' },
 { value: 'Forced trade', text: 'Forced trade' },
 { value: 'Missed it', text: 'Missed it' }
 ] },
 { id: 'setup_used_dropdown', label: 'Setup Used', category: 'setup', options: [
 { value: '', text: 'Select...' },
 { value: 'Head & Shoulders', text: 'ğŸ”ï¸ Head & Shoulders' },
 { value: 'Double Top', text: 'â›°ï¸ Double Top' },
 { value: 'MA Cross', text: 'ğŸ“Š MA Cross' },
 { value: 'Support/Resistance', text: 'â‡… Support/Resistance' },
 { value: 'Breakout - 2nd leg', text: 'ğŸ’¥ Breakout - 2nd leg' },
 { value: 'Pattern Breakout', text: 'ğŸ’¥ Pattern Breakout' },
 { value: 'Opening Breakout', text: 'ğŸŒ… Opening Breakout' },
 { value: 'Cup & Handle', text: 'â˜• Cup & Handle' },
 { value: 'RSI Overbought/Oversold', text: 'ğŸ“ˆğŸ“‰ RSI Overbought/Oversold' },
 { value: '3 Indians', text: 'ğŸ¹ 3 Indians' },
 { value: 'Pivot Points', text: 'ğŸ”ƒ Pivot Points' },
 { value: 'Candlestick Pattern', text: 'ğŸ•¯ï¸ Candlestick Pattern' }
 ] },
 { id: 'discipline_dropdown', label: 'Emotional State', category: 'discipline', options: [
 { value: '', text: 'Select...' },
 { value: 'calm', text: 'ğŸ˜Œ Calm' },
 { value: 'excited', text: 'ğŸ˜ƒ Excited' },
 { value: 'hesitant', text: 'ğŸ˜• Hesitant' },
 { value: 'frustrated', text: 'ğŸ˜¤ Frustrated' },
 { value: 'overconfident', text: 'ğŸ˜ Overconfident' },
 { value: 'revenge', text: 'ğŸ˜¡ Revenge Trading' },
 { value: 'fomo', text: 'ğŸ˜° FOMO' },
 { value: 'bored', text: 'ğŸ˜‘ Bored/Overtrading' },
 { value: 'worked_psychology', text: 'ğŸ§‘â€ğŸ« Worked on my psychology' }
 ] },
 { id: 'exit_dropdown', label: 'Exit Assessment', category: 'exit', options: [
 { value: '', text: 'Select...' },
 { value: 'Stop Hit', text: 'Stop Hit' },
 { value: 'Trailing Stop Hit', text: 'Trailing Stop Hit' },
 { value: 'Profit Target Reached', text: 'Profit Target Reached' },
 { value: 'Fearful Early Exit', text: 'Fearful Early Exit' },
 { value: 'Let Winners Run', text: 'Let Winners Run' },
 { value: 'Held Too Long', text: 'Held Too Long' }
 ] }
 ];

 // Initialize scores with default values (0 = middle of -1, 0, 1 scale)
 let scores = {
 timing: 0,
 risk: 0,
 analysis: 0,
 discipline: 0,
 exit: 0,
 results: 0
 };

 // Initialize red flags tracking
 let redFlags = new Set();
 
 // Initialize green flags tracking
 let greenFlags = new Set();

 // Function to format date as "Sep 25" instead of "2025-09-25"
 function formatDateShort(dateString) {
 const date = new Date(dateString);
 const options = { month: 'short', day: 'numeric' };
 return date.toLocaleDateString('en-US', options);
 }

 // Generate HTML for all T.R.A.D.E.R dropdowns (now per-section)
 function generateTraderDropdowns() {
 traderDropdowns.forEach(config => {
 let containerId = `${config.category}-dropdown-container`;
 if (config.category === 'market') containerId = 'market-conditions-container';
 const container = document.getElementById(containerId);
 if (!container) return; // Skip if placeholder missing

 let html = `
 <div class="question">
 <label for="${config.id}">${config.label}:</label>
 <select id="${config.id}">
 ${config.options.map(opt => `<option value="${opt.value}">${opt.text}</option>`).join('')}
 </select>
 </div>
 `;
 container.innerHTML = html;
 });
 }

// Load entry for any date
function loadEntry(date) {
    // Regenerate dropdowns first to ensure they exist
    generateTraderDropdowns();
    
    // Always clear flags on date load for clean state
    greenFlags.clear();
    redFlags.clear();
    // Clear all flag buttons visually
    document.querySelectorAll('.green-flag-btn').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.red-flag-btn').forEach(btn => btn.classList.remove('active'));
    
    const entries = JSON.parse(localStorage.getItem('tradingEntries')) || [];
    const entry = entries.find(e => e.date === date);
    
    if (entry) {
        // Scores & buttons
        if (entry.scores) {
            Object.keys(entry.scores).forEach(category => {
                scores[category] = entry.scores[category];
                updateRatingDisplay(category, entry.scores[category]);
            });
        }
        
        // Basic fields
        document.getElementById('market_timeframe').value = entry.marketTimeframe || '';
        document.getElementById('risk_percent').value = entry.riskPercent || '1.0';
        document.getElementById('setup_details').value = entry.setupDetails || '';
        document.getElementById('r_multiple').value = entry.rMultiple || '1.0';
        document.getElementById('key_takeaway').value = entry.keyTakeaway || '';
        
        // Dropdowns (now safe since generated)
        if (entry.traderTexts) {
            Object.keys(entry.traderTexts).forEach(category => {
                const dropdownId = traderDropdowns.find(config => config.category === category)?.id;
                if (dropdownId) {
                    const dropdown = document.getElementById(dropdownId);
                    if (dropdown) dropdown.value = entry.traderTexts[category];
                }
            });
        }
        if (entry.setupUsed) document.getElementById('setup_used_dropdown').value = entry.setupUsed;
        if (entry.emotionalState) document.getElementById('discipline_dropdown').value = entry.emotionalState;
        if (entry.marketConditions) document.getElementById('market_conditions').value = entry.marketConditions;
        
        // Re-apply flags from entry
        if (entry.greenFlags) {
            entry.greenFlags.forEach(flag => {
                greenFlags.add(flag);
                const button = document.querySelector(`[onclick="toggleGreenFlag('${flag}')"]`);
                if (button) button.classList.add('active');
            });
        }
        if (entry.redFlags) {
            entry.redFlags.forEach(flag => {
                redFlags.add(flag);
                const button = document.querySelector(`[onclick="toggleRedFlag('${flag}')"]`);
                if (button) button.classList.add('active');
            });
        }
    } else {
        // Clear form if no entry (manually, to preserve date)
        document.getElementById('market_timeframe').value = '';
        document.getElementById('risk_percent').value = '1.0';
        document.getElementById('setup_details').value = '';
        document.getElementById('r_multiple').value = '1.0';
        document.getElementById('key_takeaway').value = '';
        
        // Clear dropdowns manually
        traderDropdowns.forEach(config => {
            const dropdown = document.getElementById(config.id);
            if (dropdown) dropdown.value = '';
        });
        
        Object.keys(scores).forEach(category => {
            scores[category] = 0;
            updateRatingDisplay(category, 0);
        });
        // Flags already cleared above
        
        // Do NOT reset the full form to avoid clearing the date input
    }
    
    // Refresh weekly table
    displayWeeklyData();
}

 // Function to set rating and update display
 function setRating(category, rating) {
 scores[category] = rating;
 updateRatingDisplay(category, rating);
 }
 
 // Function to update rating button display
 function updateRatingDisplay(category, rating) {
 const buttons = document.querySelectorAll(`[onclick*="setRating('${category}'"]`);
 buttons.forEach((btn) => {
 const onclickAttr = btn.getAttribute('onclick');
 const ratingMatch = onclickAttr.match(/setRating\('.*?',\s*(-?\d+)\)/);
 
 if (ratingMatch) {
 const btnRating = parseInt(ratingMatch[1]);
 if (btnRating === rating) {
 btn.classList.add('selected');
 } else {
 btn.classList.remove('selected');
 }
 }
 });
 }

 // Function to toggle green flag buttons
 function toggleGreenFlag(flagName) {
 const button = document.querySelector(`[onclick="toggleGreenFlag('${flagName}')"]`);
 
 if (greenFlags.has(flagName)) {
 greenFlags.delete(flagName);
 button.classList.remove('active');
 } else {
 greenFlags.add(flagName);
 button.classList.add('active');
 }
 }
 
 // Function to toggle red flag buttons
 function toggleRedFlag(flagName) {
 const button = document.querySelector(`[onclick="toggleRedFlag('${flagName}')"]`);
 
 if (redFlags.has(flagName)) {
 redFlags.delete(flagName);
 button.classList.remove('active');
 } else {
 redFlags.add(flagName);
 button.classList.add('active');
 }
 }

 // Function to toggle main sections (green flags and red flags)
 function toggleMainSection(sectionName) {
 const header = document.querySelector(`[onclick="toggleMainSection('${sectionName}')"]`);
 const content = document.getElementById(`${sectionName}-content`);
 
 if (content.classList.contains('expanded')) {
 content.classList.remove('expanded');
 header.classList.remove('expanded');
 } else {
 content.classList.add('expanded');
 header.classList.add('expanded');
 }
 }

 // Function to toggle generic collapsible sections (T.R.A.D.E.R sections, Key Takeaway)
 function toggleSection(headerElement) {
 const content = headerElement.nextElementSibling;
 
 if (content.classList.contains('expanded')) {
 content.classList.remove('expanded');
 headerElement.classList.remove('expanded');
 } else {
 content.classList.add('expanded');
 headerElement.classList.add('expanded');
 }
 }

 // Function to switch between Daily and Weekly sections
 function showSection(sectionName) {
 const sections = document.querySelectorAll('.section');
 sections.forEach(section => section.classList.remove('active'));
 
 const navButtons = document.querySelectorAll('.nav-button');
 navButtons.forEach(button => button.classList.remove('active'));
 
 document.getElementById(sectionName).classList.add('active');
 
 event.target.classList.add('active');
 
 if (sectionName === 'weekly') {
 displayWeeklyData();
 document.getElementById('exportBtn').style.display = 'inline-block';
 document.getElementById('saveTopBtn').style.display = 'none';
 
 // Initialize column buttons only once per session
 if (!columnButtonsInitialized) {
 syncButtonStates();
 columnButtonsInitialized = true;
 }
 } else {
 document.getElementById('exportBtn').style.display = 'none';
 document.getElementById('saveTopBtn').style.display = 'inline-block'; 
 }
 
 // Load current date entry when switching back to daily (preserves selection)
if (sectionName === 'daily') {
    // Load current date entry when switching back to daily (preserves selection)
    const currentDate = document.getElementById('date').value || getLocalDateString();
    loadEntry(currentDate);
}
}
 

// Function to save a daily entry
function saveEntry() {
    const date = document.getElementById('date').value;
    
    if (!date) {
        alert('Please select a date');
        return;
    }
    
    const dailyTotal = Object.values(scores).reduce((sum, score) => sum + score, 0);
    
    const traderTexts = {};
    traderDropdowns.forEach(config => {
        traderTexts[config.category] = document.getElementById(config.id)?.value || '';
    });
    
    const entry = {
        date: date,
        marketTimeframe: document.getElementById('market_timeframe').value,
        scores: { ...scores },
        dailyTotal: dailyTotal,
        marketConditions: document.getElementById('market_conditions').value,
        riskPercent: document.getElementById('risk_percent').value,
        setupUsed: document.getElementById('setup_used_dropdown').value,
        setupDetails: document.getElementById('setup_details').value,
        emotionalState: document.getElementById('discipline_dropdown').value,
        rMultiple: document.getElementById('r_multiple').value,
        keyTakeaway: document.getElementById('key_takeaway').value,
        redFlags: Array.from(redFlags),
        greenFlags: Array.from(greenFlags),
        traderTexts: traderTexts
    };      
    
    let entries = JSON.parse(localStorage.getItem('tradingEntries')) || [];
    
    const existingIndex = entries.findIndex(entry => entry.date === date);
    
    if (existingIndex >= 0) {
        entries[existingIndex] = entry;
        const redFlagCount = entry.redFlags.length;
        const greenFlagCount = entry.greenFlags.length;
        let message = `Entry updated for ${formatDateShort(date)}\n`;
        message += `Daily Score: ${dailyTotal} (-6 to +6)\n`;
        message += `ğŸŸ¢ Green flags: ${greenFlagCount}\n`;
        message += `ğŸš© Red flags: ${redFlagCount}\n`;
        alert(message);
    } else {
        entries.push(entry);
        const redFlagCount = entry.redFlags.length;
        const greenFlagCount = entry.greenFlags.length;
        let message = `New entry saved for ${formatDateShort(date)}\n`;
        message += `Daily Score: ${dailyTotal} (-6 to +6)\n`;
        message += `ğŸŸ¢ Green flags: ${greenFlagCount}\n`;
        message += `ğŸš© Red flags: ${redFlagCount}\n`;
        alert(message);
    }
    
    localStorage.setItem('tradingEntries', JSON.stringify(entries));
    
    // Explicitly reload the saved entry (stays on selected date)
    setTimeout(() => {
        loadEntry(date);
    }, 50);  // Small delay to ensure localStorage sync
}
 
 function exportToCSV() {
 const entries = JSON.parse(localStorage.getItem('tradingEntries')) || [];
 
 if (entries.length === 0) {
 alert('No data to export');
 return;
 }
 
 // CSV headers
 let csv = 'Date,Instrument,T Score,R Score,A Score,D Score,E Score,R Score,';
 csv += 'Timing,Risk,Analysis Quality,Setup Type,Emotional State,Exit,';
 csv += 'Market Condition,R-Multiple,Setup Details,Green Flags,Red Flags,Key Takeaway\n';
 
 // Sort by date
 entries.sort((a, b) => new Date(a.date) - new Date(b.date));
 
 // Add data rows
 entries.forEach(entry => {
 const row = [
 entry.date,
 entry.marketTimeframe || '',
 entry.scores?.timing || 0,
 entry.scores?.risk || 0,
 entry.scores?.analysis || 0,
 entry.scores?.discipline || 0,
 entry.scores?.exit || 0,
 entry.scores?.results || 0,
 entry.traderTexts?.timing || '',
 entry.traderTexts?.risk || '',
 entry.traderTexts?.analysis_quality || '',
 entry.traderTexts?.analysis_type || '',
 entry.emotionalState || '',
 entry.traderTexts?.exit || '',
 entry.marketConditions || '',
 entry.rMultiple || '',
 entry.setupDetails || '',
 entry.greenFlags?.join(', ') || '',
 entry.redFlags?.join(', ') || '',
 (entry.keyTakeaway || '').replace(/"/g, '""')
 ];
 
 csv += row.map(field => `"${field}"`).join(',') + '\n';
 });
 
 // Create download
 const blob = new Blob([csv], { type: 'text/csv' });
 const url = window.URL.createObjectURL(blob);
 const a = document.createElement('a');
 a.href = url;
 a.download = `trading_journal_${getLocalDateString()}.csv`;
 document.body.appendChild(a);
 a.click();
 document.body.removeChild(a);
 window.URL.revokeObjectURL(url);
 }

 // Global variable to track current filter
 let currentFilter = 'last30';

 // Track which columns are visible
 let visibleColumns = {
 timing: false,
 risk: false,
 analysis: false,
 discipline: false,
 exit: false,
 results: false,
 setup: false,
 market: false,
 rvalue: false,
 greenflags: true,
 redflags: true,
 takeaway: false
 };

 // Track if column buttons have been initialized
 let columnButtonsInitialized = false;

 // Toggle column visibility
 function toggleColumn(columnName) {
 visibleColumns[columnName] = !visibleColumns[columnName];
 
 // Save to localStorage
 localStorage.setItem('columnPreferences', JSON.stringify(visibleColumns));
 
 // Update button appearance
 const btn = document.getElementById(`toggle-${columnName}`);
 if (visibleColumns[columnName]) {
 btn.classList.add('active');
 } else {
 btn.classList.remove('active');
 }
 
 // Refresh the table
 displayWeeklyData();
 }

 // Sync button states with visibleColumns preferences
 function syncButtonStates() {
 Object.keys(visibleColumns).forEach(columnName => {
 const btn = document.getElementById(`toggle-${columnName}`);
 if (btn) {
 if (visibleColumns[columnName]) {
 btn.classList.add('active');
 } else {
 btn.classList.remove('active');
 }
 }
 });
 }

 // Function to filter weekly data by date range
 function filterWeeklyData(filterType) {
 // Update the current filter
 currentFilter = filterType;
 
 // Update ONLY timeframe button styles (not column toggles)
 document.querySelectorAll('.timeframe-btn').forEach(btn => {
 btn.classList.remove('active');
 });
 event.target.classList.add('active');
 
 // Re-display the data with the new filter
 displayWeeklyData();
 }
 
 // Helper function to get date ranges
 function getDateRange(filterType) {
 const now = new Date();
 let startDate, endDate;
 
 switch(filterType) {
 case 'last30':
 // Last 30 days
 startDate = new Date(now);
 startDate.setDate(now.getDate() - 30);
 endDate = now;
 break;
 
 case 'thisWeek':
 // This week (Monday to Sunday)
 const dayOfWeek = now.getDay();
 const monday = new Date(now);
 monday.setDate(now.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
 startDate = monday;
 endDate = now;
 break;
 
 case 'lastWeek':
 // Last week (previous Monday to Sunday)
 const lastMonday = new Date(now);
 const currentDay = now.getDay();
 lastMonday.setDate(now.getDate() - (currentDay === 0 ? 6 : currentDay - 1) - 7);
 const lastSunday = new Date(lastMonday);
 lastSunday.setDate(lastMonday.getDate() + 6);
 startDate = lastMonday;
 endDate = lastSunday;
 break;
 
 case 'all':
 // All time - no filter
 return null;
 
 default:
 return null;
 }
 
 return { startDate, endDate };
 }



 // Function to display weekly data in a table
 function displayWeeklyData() {
 let entries = JSON.parse(localStorage.getItem('tradingEntries')) || [];
 
 const tableContainer = document.getElementById('weeklyTable');
 
 if (entries.length === 0) {
 tableContainer.innerHTML = '<div class="no-data">No entries saved yet. Add some daily entries first!</div>';
 return;
 }
 
 // Apply date filter
 const dateRange = getDateRange(currentFilter);
 if (dateRange) {
 entries = entries.filter(entry => {
 const entryDate = new Date(entry.date);
 return entryDate >= dateRange.startDate && entryDate <= dateRange.endDate;
 });
 }
 
 // Check if we have entries after filtering
 if (entries.length === 0) {
 tableContainer.innerHTML = '<div class="no-data">No entries found for this date range.</div>';
 return;
 }
 
 entries.sort((a, b) => new Date(b.date) - new Date(a.date));
 
 // Helper function to convert score to symbol
 function scoreToSymbol(score) {
 if (score === -1) return 'âŒ';
 if (score === 0) return 'âšª';
 if (score === 1) return 'âœ”ï¸';
 return '';
 }
 
 // Build dynamic table header
 let headerHTML = '<tr><th>Date</th><th>Instrument</th>';
 
 if (visibleColumns.timing) headerHTML += '<th>T - Timing</th>';
 if (visibleColumns.risk) headerHTML += '<th>R - Risk</th>';
 if (visibleColumns.analysis) headerHTML += '<th>A - Analysis</th>';
 if (visibleColumns.discipline) headerHTML += '<th>D - Discipline</th>';
 if (visibleColumns.exit) headerHTML += '<th>E - Exit</th>';
 if (visibleColumns.results) headerHTML += '<th>R - Results</th>';
 if (visibleColumns.setup) headerHTML += '<th>Setup</th>';
 if (visibleColumns.market) headerHTML += '<th>Market</th>';
 if (visibleColumns.rvalue) headerHTML += '<th>R value</th>';
 if (visibleColumns.greenflags) headerHTML += '<th class="red-flags-column">Green Flags</th>';
 if (visibleColumns.redflags) headerHTML += '<th class="red-flags-column">Red Flags</th>';
 if (visibleColumns.takeaway) headerHTML += '<th>Key Takeaway</th>';
 
 headerHTML += '</tr>';
 
 let tableHTML = `<table><thead>${headerHTML}</thead><tbody>`;
 
 entries.forEach(entry => {
 let rowHTML = '<tr>';
 
 // Always show Date and Instrument
 rowHTML += `<td>${formatDateShort(entry.date)}</td>`;
 rowHTML += `<td>${entry.marketTimeframe || ''}</td>`;
 
 // T.R.A.D.E.R components (show score + details if visible)
 if (visibleColumns.timing) {
 const score = entry.scores?.timing || 0;
 const detail = entry.traderTexts?.timing || '';
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}<br>${detail}</td>`;
 }
 
 if (visibleColumns.risk) {
 const score = entry.scores?.risk || 0;
 const detail = entry.traderTexts?.risk || '';
 const riskPercent = entry.riskPercent ? ` (${entry.riskPercent}%)` : '';
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}<br>${detail}${riskPercent}</td>`;
 }
 
 if (visibleColumns.analysis) {
 const score = entry.scores?.analysis || 0;
 const detail = entry.traderTexts?.analysis_quality || '';
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}<br>${detail}</td>`;
 }
 
 if (visibleColumns.discipline) {
 const score = entry.scores?.discipline || 0;
 const detail = entry.emotionalState || '';
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}<br>${detail}</td>`;
 }
 
 if (visibleColumns.exit) {
 const score = entry.scores?.exit || 0;
 const detail = entry.traderTexts?.exit || '';
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}<br>${detail}</td>`;
 }
 
 if (visibleColumns.results) {
 const score = entry.scores?.results || 0;
 rowHTML += `<td style="font-size: 11px;">${scoreToSymbol(score)}</td>`;
 }
 
 // Setup
 if (visibleColumns.setup) {
 const setupDisplay = [entry.setupUsed, entry.setupDetails].filter(Boolean).join('<br>â€“ ') || '';
 rowHTML += `<td>${setupDisplay}</td>`;
 }
 
 // Market
 if (visibleColumns.market) {
 const conditionText = {
 'strong_uptrend': 'Strong Uptrend',
 'strong_downtrend': 'Strong Downtrend',
 'ranging_sideways': 'Ranging/Sideways',
 'high_volatility': 'High Volatility',
 'low_volatility': 'Low Volatility'
 };
 const marketDisplay = conditionText[entry.marketConditions] || entry.marketConditions || '';
 rowHTML += `<td>${marketDisplay}</td>`;
 }
 
 // R value
 if (visibleColumns.rvalue) {
 rowHTML += `<td>${entry.rMultiple || ''}</td>`;
 }
 
 // Green Flags
 if (visibleColumns.greenflags) {
 let greenFlagsDisplay = '';
 if (entry.greenFlags && entry.greenFlags.length > 0) {
 const greenFlagLabels = {
 'followed_plan': 'Plan',
 'premarket_analysis': 'Analysis',
 'waited_setup': 'Setup',
 'correct_timeframes': 'Timeframes',
 'perfect_position_size': 'Position',
 'quick_loss_cut': 'Cut Loss',
 'hit_profit_target': 'Target',
 'avoided_chasing': 'No Chase',
 'emotional_control': 'Control',
 'documented_trades': 'Docs',
 'post_trade_analysis': 'Analysis',
 'applied_lessons': 'Lessons',
 'stuck_risk_limits': 'Risk Limits',
 'waited_confluence': 'Confluence',
 'reviewed_last_trade': 'Reviewed Last',
 'neutral_mindset': 'Neutral Mindset',
 'documented_rationale': 'Rationale',
 'exited_on_plan': 'Exited on Plan',
 'adapted_conditions': 'Adapted',
 'celebrated_small_win': 'Small Win'
 };
 greenFlagsDisplay = entry.greenFlags.map(flag => 
 `<span class="green-flag-tag">${greenFlagLabels[flag] || flag}</span>`
 ).join(' ');
 }
 rowHTML += `<td class="red-flags-column">${greenFlagsDisplay}</td>`;
 }
 
 // Red Flags
 if (visibleColumns.redflags) {
 let redFlagsDisplay = '';
 if (entry.redFlags && entry.redFlags.length > 0) {
 const flagLabels = {
 'revenge': 'Revenge',
 'overtrading': 'Overtrade',
 'fomo': 'FOMO',
 'moved_stop': 'Moved SL',
 'added_loser': 'Added Loss',
 'no_plan': 'No Plan',
 'ignored_risk': 'Risk',
 'trader_error': 'Trader',
 'news_trade': 'News',
 'hope_hold': 'Hope',
 'early_exit': 'Early Exit',
 'herd_behavior': 'Herd',
 'loss_aversion': 'Held Loser',
 'overconfidence': 'Overconfident',
 'confirmation_bias': 'Confirmation',
 'illusion_control': 'Illusion Control',
 'social_influence': 'Social Impulse' 
 };
 redFlagsDisplay = entry.redFlags.map(flag => 
 `<span class="red-flag-tag">${flagLabels[flag] || flag}</span>`
 ).join(' ');
 }
 rowHTML += `<td class="red-flags-column">${redFlagsDisplay}</td>`;
 }
 
 // Takeaway
 if (visibleColumns.takeaway) {
 const takeawayDisplay = entry.keyTakeaway || '';
 rowHTML += `<td>
 <div style="
 display: -webkit-box;
 -webkit-line-clamp: 3;
 -webkit-box-orient: vertical;
 overflow: hidden;
 text-overflow: ellipsis;
 white-space: normal;
 word-break: break-word;
 line-height: 1.5em;
 height: 100%;
 cursor: help;
 " title="${takeawayDisplay.replace(/"/g, '&quot;')}">
 ${takeawayDisplay}
 </div>
 </td>`;
 }
 
 rowHTML += '</tr>';
 tableHTML += rowHTML;
 });
 
 tableHTML += '</tbody></table>';
 tableContainer.innerHTML = tableHTML;
 }

 // Load entry for today's date
function loadTodayEntry() {
    loadEntry(getLocalDateString());
}

// Set today's date automatically when page loads
window.onload = function() {
    document.getElementById('date').value = getLocalDateString();

    // Load entry when date changes
    document.getElementById('date').addEventListener('change', function() {
        loadEntry(this.value);
    });
    
    // Load column preferences from localStorage
    const savedPreferences = localStorage.getItem('columnPreferences');
    if (savedPreferences) {
        visibleColumns = JSON.parse(savedPreferences);
    }
    
    // Generate dropdowns after date setup
    generateTraderDropdowns();
    
    loadTodayEntry();
    
    displayWeeklyData();
};

    // ---------- MONTHLY GOAL PROGRESS ----------

function updateGoalBar(){
  let target = Math.max(1, parseInt(document.getElementById('goalTarget').value) || 1);
  let done   = Math.max(0, parseInt(document.getElementById('goalDone').value)  || 0);

  // ---- keep done inside 0-target ----
  done = Math.min(done, target);
  // -----------------------------------
  document.getElementById('goalDone').value = done;     // visually cap it

  const pct = Math.round((done / target) * 100);
  document.getElementById('goalBar').style.width = pct + '%';
  document.getElementById('goalPct').textContent = pct + ' %';

  localStorage.setItem('monthlyGoalTarget', target);
  localStorage.setItem('monthlyGoalDone',   done);
}

function loadMonthlyGoal(){
  const t = localStorage.getItem('monthlyGoalTarget') || 20;
  const d = localStorage.getItem('monthlyGoalDone')   || 0;
  document.getElementById('goalTarget').value = t;
  document.getElementById('goalDone').value   = d;
  updateGoalBar();          // paints the bar
}
window.addEventListener('DOMContentLoaded', loadMonthlyGoal);
    

    // ---------- GOAL TITLE (EDITABLE) ----------
    function saveGoalTitle(){
    const txt = document.getElementById('goalTitleEdit').value.trim() || 'ğŸ¯ Monthly Goal';
    localStorage.setItem('monthlyGoalTitle', txt);
    document.getElementById('goalTitle').textContent = txt;
    document.getElementById('goalTitle').style.display = 'inline';
    document.getElementById('goalTitleEdit').style.display = 'none';
    }
    // toggle edit mode
    document.getElementById('goalTitle').addEventListener('click', () => {
    const el  = document.getElementById('goalTitleEdit');
    el.value  = document.getElementById('goalTitle').textContent;
    el.style.display = 'inline';
    el.focus();
    el.select();
    });

    // ---------- LOAD EVERYTHING ----------
    function loadMonthlyGoal(){
    const t = localStorage.getItem('monthlyGoalTarget') || 20;
    const d = localStorage.getItem('monthlyGoalDone')   || 0;
    const title = localStorage.getItem('monthlyGoalTitle') || 'ğŸ¯ Monthly Goal';
    document.getElementById('goalTarget').value = t;
    document.getElementById('goalDone').value   = d;
    document.getElementById('goalTitle').textContent = title;
    updateGoalBar();          // paints the bar
    }
    window.addEventListener('DOMContentLoaded', loadMonthlyGoal);    
 </script>
</body>
</html>
